{% extends "base.html" %}
{% load humanize ppa_tags %}
{% block page-subtitle %}Archive | {% endblock %}

{% block head_extras %}
    <link rel="unapi-server" type="application/xml" title="unAPI"
          href="{% url 'unapi' %}" />
{% endblock %}

{% block content %}
<h1>Archive</h1>

<form>
{{ search_form }}
<input type="submit"/>
</form>

{% if error %}
{# if something went wrong (e.g., bad query), display error message and nothing else #}
<p>{{ error }}</p>
{% else %}

<p>{{ paginator.count|intcomma }} digitized work{{ paginator.count|pluralize }}.</p>
<hr/>

<ol start="{{ page_obj.start_index }}">
    {% for item in object_list %}
    <li>
        <h3><a href="{% url 'archive:detail' item.srcid %}">{{ item.title }}</a></h3>
        <p>sort title: {{ item.title_exact }}</p>
        <p>author: {{ item.author }}</p>
        {% if item.enumcron %}<p>{{ item.enumcron }}</p> {% endif %}
        <p>{{ item.publisher }} {{ item.pub_place }} {{ item.pub_date }}</p>
        <p><small><a href="{{ item.src_url }}">{{ item.srcid }}</a></small></p>

        <abbr class="unapi-id" title="{{ item.id }}"></abbr>
        {% with results=page_groups|dict_item:item.id %}
            {% if page_highlights %}
                {% for page in results.docs %}
                    <div style="float: left; max-width: 50%">
                        {# thumbnail image from hathi #}
                        {# coerce page order to integer, then format as number to drop leading zeroes #}
                        <img src="https://babel.hathitrust.org/cgi/imgsrv/image?id={{ item.id }};seq={{ page.order|add:0|stringformat:'d' }};width=180"
                            style="float:left"/>

                        {% with page_highlights=page_highlights|dict_item:page.id %}
                            {% for snippet in page_highlights.content %}
                            <p style="white-space: pre-wrap">{{ snippet|safe }}</p>
                            {% endfor %}
                        {% endwith %}
                    </div>

                {% endfor %}

                <div style="clear: both"/>
                {# link to page with search if there are more than two pages #}
                {% if results.numFound > 2 %}
                <a href="{% url 'archive:detail' item.srcid %}?query={{ query }}">View all {{ results.numFound|intcomma }} page{{ results.numFound|pluralize }} â†’</a>
                {% endif %}
            {% endif %}
        {% endwith %}
        {% if item.collections %}
        <p><b>collections:</b> {{ item.collections|join:", " }}</p>
        {% endif %}
        {% if sort == 'Relevance' %}
            <p><small>relevance: {{ item.score }}</small></p>
        {% endif %}
    </li>
    {% empty %}
    <li>No matching items found</li>
    {% endfor %}
</ol>

<div class="pagination">
    <span class="step-links">
        {% if page_obj.has_previous %}
            <a href="?{% querystring_replace page=1 %}">&laquo; first</a>
            <a href="?{% querystring_replace page=page_obj.previous_page_number %}">previous</a>
        {% endif %}

        <span class="current">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
        </span>

        {% if page_obj.has_next %}
            <a href="?{% querystring_replace page=page_obj.next_page_number %}">next</a>
            <a href="?{% querystring_replace page=page_obj.paginator.num_pages %}">last &raquo;</a>
        {% endif %}
    </span>
</div>

{% endif %}
{% endblock %}
