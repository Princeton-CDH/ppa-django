
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>ppa.archive.models &#8212; Princeton Prosody Archive 3.3.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ppa.archive.models</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="k">import</span> <span class="n">ZipFile</span>

<span class="kn">from</span> <span class="nn">cached_property</span> <span class="k">import</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.admin.models</span> <span class="k">import</span> <span class="n">LogEntry</span><span class="p">,</span> <span class="n">ADDITION</span><span class="p">,</span> <span class="n">CHANGE</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="k">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="k">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.contrib.contenttypes.models</span> <span class="k">import</span> <span class="n">ContentType</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="k">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="k">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">eulxml.xmlmap</span> <span class="k">import</span> <span class="n">load_xmlobject_from_file</span>
<span class="kn">from</span> <span class="nn">flags</span> <span class="k">import</span> <span class="n">Flags</span>
<span class="kn">from</span> <span class="nn">pairtree</span> <span class="k">import</span> <span class="n">pairtree_path</span><span class="p">,</span> <span class="n">pairtree_client</span><span class="p">,</span> <span class="n">storage_exceptions</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">wagtail.core.fields</span> <span class="k">import</span> <span class="n">RichTextField</span>
<span class="kn">from</span> <span class="nn">wagtail.admin.edit_handlers</span> <span class="k">import</span> <span class="n">FieldPanel</span>
<span class="kn">from</span> <span class="nn">wagtail.snippets.models</span> <span class="k">import</span> <span class="n">register_snippet</span>

<span class="kn">from</span> <span class="nn">ppa.archive.hathi</span> <span class="k">import</span> <span class="n">HathiBibliographicAPI</span><span class="p">,</span> <span class="n">MinimalMETS</span><span class="p">,</span> \
    <span class="n">HathiDataAPI</span><span class="p">,</span> <span class="n">HathiObject</span>
<span class="kn">from</span> <span class="nn">ppa.archive.solr</span> <span class="k">import</span> <span class="n">Indexable</span>
<span class="kn">from</span> <span class="nn">ppa.archive.solr</span> <span class="k">import</span> <span class="n">PagedSolrQuery</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1">#: label to use for items that are not in a collection</span>
<span class="n">NO_COLLECTION_LABEL</span> <span class="o">=</span> <span class="s1">&#39;Uncategorized&#39;</span>


<div class="viewcode-block" id="TrackChangesModel"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.TrackChangesModel">[docs]</a><span class="k">class</span> <span class="nc">TrackChangesModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;:class:`~django.modles.Model` mixin that keeps a copy of initial</span>
<span class="sd">    data in order to check if fields have been changed. Change detection</span>
<span class="sd">    only works on the current instance of an object.&#39;&#39;&#39;</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># store a copy of model data to allow for checking if</span>
        <span class="c1"># it has changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<div class="viewcode-block" id="TrackChangesModel.save"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.TrackChangesModel.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Saves data and reset copy of initial data.&#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># update copy of initial data to reflect saved state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrackChangesModel.has_changed"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.TrackChangesModel.has_changed">[docs]</a>    <span class="k">def</span> <span class="nf">has_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;check if a field has been changed&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__initial</span><span class="p">[</span><span class="n">field</span><span class="p">]</span></div>

<div class="viewcode-block" id="TrackChangesModel.initial_value"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.TrackChangesModel.initial_value">[docs]</a>    <span class="k">def</span> <span class="nf">initial_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;return the initial value for a field&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__initial</span><span class="p">[</span><span class="n">field</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="Collection"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.Collection">[docs]</a><span class="nd">@register_snippet</span>
<span class="k">class</span> <span class="nc">Collection</span><span class="p">(</span><span class="n">TrackChangesModel</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A collection of :class:`ppa.archive.models.DigitizedWork` instances.&#39;&#39;&#39;</span>
    <span class="c1">#: the name of the collection</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="c1">#: a RichText description of the collection</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">RichTextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: flag to indicate collections to be excluded by default in</span>
    <span class="c1">#: public search</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Exclude by default on public search.&#39;</span><span class="p">)</span>

    <span class="c1"># configure for editing in wagtail admin</span>
    <span class="n">panels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">FieldPanel</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
        <span class="n">FieldPanel</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;check if name has been changed (only works on current instance)&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Collection.stats"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.Collection.stats">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">stats</span><span class="p">():</span>
        <span class="sd">&#39;&#39;&#39;Collection counts and date ranges, based on what is in Solr.</span>
<span class="sd">        Returns a dictionary where they keys are collection names and</span>
<span class="sd">        values are a dictionary with count and dates.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># NOTE: if we *only* want counts, could just do a regular facet</span>
        <span class="n">solr_stats</span> <span class="o">=</span> <span class="n">PagedSolrQuery</span><span class="p">({</span>
            <span class="s1">&#39;q&#39;</span><span class="p">:</span> <span class="s1">&#39;*:*&#39;</span><span class="p">,</span>
            <span class="s1">&#39;facet&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;facet.pivot&#39;</span><span class="p">:</span> <span class="s1">&#39;{!stats=piv1}collections_exact&#39;</span><span class="p">,</span>
            <span class="c1"># NOTE: if we pivot on collection twice, like this, we should</span>
            <span class="c1"># have the information needed to generate a venn diagram</span>
            <span class="c1"># of the collections (based on number of overlap)</span>
            <span class="c1"># &#39;facet.pivot&#39;: &#39;{!stats=piv1}collections_exact,collections_exact&#39;</span>
            <span class="s1">&#39;stats&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;stats.field&#39;</span><span class="p">:</span> <span class="s1">&#39;{!tag=piv1 min=true max=true}pub_date&#39;</span><span class="p">,</span>
            <span class="c1"># don&#39;t return any actual items, just the facets</span>
            <span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">})</span>
        <span class="n">facet_pivot</span> <span class="o">=</span> <span class="n">solr_stats</span><span class="o">.</span><span class="n">raw_response</span><span class="p">[</span><span class="s1">&#39;facet_counts&#39;</span><span class="p">][</span><span class="s1">&#39;facet_pivot&#39;</span><span class="p">]</span>
        <span class="c1"># simplify the pivot stat data for display</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">facet_pivot</span><span class="p">[</span><span class="s1">&#39;collections_exact&#39;</span><span class="p">]:</span>
            <span class="n">pub_date_stats</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;stats&#39;</span><span class="p">][</span><span class="s1">&#39;stats_fields&#39;</span><span class="p">][</span><span class="s1">&#39;pub_date&#39;</span><span class="p">]</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">],</span>
                <span class="s1">&#39;dates&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%(min)d</span><span class="s1">–</span><span class="si">%(max)d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pub_date_stats</span> \
                    <span class="k">if</span> <span class="n">pub_date_stats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pub_date_stats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span> \
                    <span class="k">else</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pub_date_stats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">stats</span></div></div>


<div class="viewcode-block" id="ProtectedWorkFieldFlags"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.ProtectedWorkFieldFlags">[docs]</a><span class="k">class</span> <span class="nc">ProtectedWorkFieldFlags</span><span class="p">(</span><span class="n">Flags</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;:class:`flags.Flags` instance to indicate which :class:`DigitizedWork`</span>
<span class="sd">    fields should be protected if edited in the admin.&#39;&#39;&#39;</span>
    <span class="c1">#: title</span>
    <span class="n">title</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1">#: subtitle</span>
    <span class="n">subtitle</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1">#: sort title</span>
    <span class="n">sort_title</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1">#: enumcron</span>
    <span class="n">enumcron</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1">#: author</span>
    <span class="n">author</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1">#: place of publication</span>
    <span class="n">pub_place</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1">#: publisher</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1">#: publication date</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="ProtectedWorkFieldFlags.deconstruct"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.ProtectedWorkFieldFlags.deconstruct">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">deconstruct</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Give Django information needed to make</span>
<span class="sd">        :class:`ProtectedWorkFieldFlags.no_flags` default in migration.&#39;&#39;&#39;</span>
        <span class="c1"># (import path, [args], kwargs)</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;ppa.archive.models.ProtectedWorkFieldFlags&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;no_flags&#39;</span><span class="p">],</span> <span class="p">{})</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_simple_str</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)))</span></div>


<div class="viewcode-block" id="ProtectedWorkField"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.ProtectedWorkField">[docs]</a><span class="k">class</span> <span class="nc">ProtectedWorkField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;PositiveSmallIntegerField subclass that returns a</span>
<span class="sd">    :class:`ProtectedWorkFieldFlags` object and stores as integer.&#39;&#39;&#39;</span>

    <span class="n">description</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;A field that stores an instance of :class:`ProtectedWorkFieldFlags` &#39;</span>
                   <span class="s1">&#39;as an integer.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Make the field unnullable and not allowed to be blank.&#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">verbose_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ProtectedWorkField.from_db_value"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.ProtectedWorkField.from_db_value">[docs]</a>    <span class="k">def</span> <span class="nf">from_db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Always return an instance of :class:`ProtectedWorkFieldFlags`&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">ProtectedWorkFieldFlags</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">get_internal_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;PositiveSmallIntegerField&#39;</span>

<div class="viewcode-block" id="ProtectedWorkField.get_prep_value"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.ProtectedWorkField.get_prep_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_prep_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="ProtectedWorkField.to_python"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.ProtectedWorkField.to_python">[docs]</a>    <span class="k">def</span> <span class="nf">to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Always return an instance of :class:`ProtectedWorkFieldFlags`&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">ProtectedWorkFieldFlags</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CollectionSignalHandlers"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.CollectionSignalHandlers">[docs]</a><span class="k">class</span> <span class="nc">CollectionSignalHandlers</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;Signal handlers for indexing :class:`DigitizedWork` records when</span>
<span class="sd">    :class:`Collection` records are saved or deleted.&#39;&#39;&#39;</span>

<div class="viewcode-block" id="CollectionSignalHandlers.save"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.CollectionSignalHandlers.save">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;signal handler for collection save; reindex associated digitized works&#39;&#39;&#39;</span>
        <span class="c1"># only reindex if collection name has changed</span>
        <span class="c1"># and if collection has already been saved</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">pk</span> <span class="ow">and</span> <span class="n">instance</span><span class="o">.</span><span class="n">name_changed</span><span class="p">:</span>
            <span class="c1"># if the collection has any works associated</span>
            <span class="n">works</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">digitizedwork_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">works</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;collection save, reindexing </span><span class="si">%d</span><span class="s1"> related works&#39;</span><span class="p">,</span> <span class="n">works</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
                <span class="n">Indexable</span><span class="o">.</span><span class="n">index_items</span><span class="p">(</span><span class="n">works</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;commitWithin&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">})</span></div>

<div class="viewcode-block" id="CollectionSignalHandlers.delete"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.CollectionSignalHandlers.delete">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;signal handler for collection delete; clear associated digitized</span>
<span class="sd">        works and reindex&#39;&#39;&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;collection delete&#39;</span><span class="p">)</span>
        <span class="c1"># get a list of ids for collected works before clearing them</span>
        <span class="n">digwork_ids</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">digitizedwork_set</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># find the items based on the list of ids to reindex</span>
        <span class="n">digworks</span> <span class="o">=</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">digwork_ids</span><span class="p">))</span>

        <span class="c1"># NOTE: this sends pre/post clear signal, but it&#39;s not obvious</span>
        <span class="c1"># how to take advantage of that</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">digitizedwork_set</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">Indexable</span><span class="o">.</span><span class="n">index_items</span><span class="p">(</span><span class="n">digworks</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;commitWithin&#39;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">})</span></div></div>


<div class="viewcode-block" id="DigitizedWork"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork">[docs]</a><span class="k">class</span> <span class="nc">DigitizedWork</span><span class="p">(</span><span class="n">TrackChangesModel</span><span class="p">,</span> <span class="n">Indexable</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Record to manage digitized works included in PPA and store their basic</span>
<span class="sd">    metadata.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">HATHI</span> <span class="o">=</span> <span class="s1">&#39;HT&#39;</span>
    <span class="n">OTHER</span> <span class="o">=</span> <span class="s1">&#39;O&#39;</span>
    <span class="n">SOURCE_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">HATHI</span><span class="p">,</span> <span class="s1">&#39;HathiTrust&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">OTHER</span><span class="p">,</span> <span class="s1">&#39;Other&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1">#: source of the record, HathiTrust or elsewhere</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">SOURCE_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">HATHI</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Source of the record.&#39;</span><span class="p">)</span>
    <span class="c1">#: source identifier; hathi id for HathiTrust materials</span>
    <span class="n">source_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;Source ID&#39;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Source identifier. Unique identifier without spaces; &#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;used for site URL. (HT id for HathiTrust materials.)&#39;</span><span class="p">)</span>
    <span class="c1">#: source url where the original can be accessed</span>
    <span class="n">source_url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="s1">&#39;Source URL&#39;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;URL where the source item can be accessed&#39;</span><span class="p">)</span>
    <span class="c1">#: record id; for Hathi materials, used for different copies of</span>
    <span class="c1">#: the same work or for different editions/volumes of a work</span>
    <span class="n">record_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;For HathiTrust materials, record id (use to aggregate &#39;</span> <span class="o">+</span> \
                  <span class="s1">&#39;copies or volumes).&#39;</span><span class="p">)</span>
    <span class="c1">#: title of the work; using TextField to allow for long titles</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Main title&#39;</span><span class="p">)</span>
    <span class="c1">#: subtitle of the work; using TextField to allow for long titles</span>
    <span class="n">subtitle</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Subtitle, if any (optional)&#39;</span><span class="p">)</span>
    <span class="c1">#: sort title: title without leading non-sort characters, from marc</span>
    <span class="n">sort_title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Sort title from MARC record or title without leading article&#39;</span><span class="p">)</span>
    <span class="c1">#: enumeration/chronology (hathi-specific)</span>
    <span class="n">enumcron</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s1">&#39;Enumeration/Chronology&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
                                <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># TODO: what is the generic/non-hathi name for this? volume/version?</span>

    <span class="c1"># NOTE: may eventually to convert to foreign key</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Authorized name of the author, last name first.&#39;</span><span class="p">)</span>
    <span class="c1">#: place of publication</span>
    <span class="n">pub_place</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s1">&#39;Place of Publication&#39;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
                                 <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: publisher</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Needs to be integer to allow aggregating max/min, filtering by date</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="s1">&#39;Publication Date&#39;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: number of pages in the work</span>
    <span class="n">page_count</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: public notes field for this work</span>
    <span class="n">public_notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Notes on edition or other details (displayed on public site)&#39;</span><span class="p">)</span>
    <span class="c1">#: internal team notes, not displayed on the public facing site</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Internal curation notes (not displayed on public site)&#39;</span><span class="p">)</span>
    <span class="c1">#: :class:`ProtectedWorkField` instance to indicate metadata fields</span>
    <span class="c1">#: that should be preserved from bulk updates because they have been</span>
    <span class="c1">#: modified in Django admin.</span>
    <span class="n">protected_fields</span> <span class="o">=</span> <span class="n">ProtectedWorkField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">ProtectedWorkFieldFlags</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Fields protected from HathiTrust bulk &#39;</span>
                  <span class="s1">&#39;update because they have been manually edited in the &#39;</span>
                  <span class="s1">&#39;Django admin.&#39;</span>
    <span class="p">)</span>
    <span class="c1">#: collections that this work is part of</span>
    <span class="n">collections</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: date added to the archive</span>
    <span class="n">added</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: date of last modification of the local record</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">PUBLIC</span> <span class="o">=</span> <span class="s1">&#39;P&#39;</span>
    <span class="n">SUPPRESSED</span> <span class="o">=</span> <span class="s1">&#39;S&#39;</span>
    <span class="n">STATUS_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">PUBLIC</span><span class="p">,</span> <span class="s1">&#39;Public&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">SUPPRESSED</span><span class="p">,</span> <span class="s1">&#39;Suppressed&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1">#: status of record; currently choices are public or suppressed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">STATUS_CHOICES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">PUBLIC</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s1">&#39;Changing status to suppressed will remove rsync data &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;for that volume and remove from the public index. This is &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;currently not reversible; use with caution.&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;sort_title&#39;</span><span class="p">,)</span>

<div class="viewcode-block" id="DigitizedWork.get_absolute_url"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.get_absolute_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return object&#39;s url for</span>
<span class="sd">        :class:`ppa.archive.views.DigitizedWorkDetailView`</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;archive:detail&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;source_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">})</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Default string display. Uses :attr:`source_id`&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_suppressed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Item has been suppressed (based on :attr:`status`).&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPRESSED</span>

<div class="viewcode-block" id="DigitizedWork.display_title"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.display_title">[docs]</a>    <span class="k">def</span> <span class="nf">display_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;admin display title to allow displaying title but sorting on sort_title&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span></div>
    <span class="n">display_title</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;title&#39;</span>
    <span class="n">display_title</span><span class="o">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s1">&#39;sort_title&#39;</span>

<div class="viewcode-block" id="DigitizedWork.is_public"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.is_public">[docs]</a>    <span class="k">def</span> <span class="nf">is_public</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;admin display field indicating if record is public or suppressed&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PUBLIC</span></div>
    <span class="n">is_public</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;Public&#39;</span>
    <span class="n">is_public</span><span class="o">.</span><span class="n">boolean</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">is_public</span><span class="o">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s1">&#39;status&#39;</span>

    <span class="c1">#: regular expresion for cleaning preliminary text from publisher names</span>
    <span class="n">printed_by_re</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^(Printed)?( and )?(Pub(.|lished|lisht)?)?( and sold)? (by|for|at)( the)? ?&#39;</span>
    <span class="c1"># Printed by/for (the); Printed and sold by; Printed and published by;</span>
    <span class="c1"># Pub./Published/Publisht at/by/for the</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">has_fulltext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Checks if an item has full text (currently only items from</span>
<span class="sd">        HathiTrust).&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">HATHI</span>
        
    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">hathi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;:class:`ppa.archive.hathi.HathiObject` for HathiTrust records,</span>
<span class="sd">        for working with data in HathiTrust pairtree data structure.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">HATHI</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HathiObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="DigitizedWork.save"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># if status has changed so that object is now suppressed and this</span>
        <span class="c1"># is a HathiTrust item, remove pairtree data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPRESSED</span> \
          <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">HATHI</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hathi</span><span class="o">.</span><span class="n">delete_pairtree_data</span><span class="p">()</span>

        <span class="c1"># source id is used as Solr identifier; if it changes, remove</span>
        <span class="c1"># the old record from Solr before saving with the new identifier</span>
        <span class="c1"># NOTE: source id edit only supported for non-hathi content; should</span>
        <span class="c1"># be prevented by validation in clean method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s1">&#39;source_id&#39;</span><span class="p">):</span>
            <span class="n">new_source_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_value</span><span class="p">(</span><span class="s1">&#39;source_id&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_from_index</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;commitWithin&quot;</span><span class="p">:</span> <span class="mi">3000</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span> <span class="o">=</span> <span class="n">new_source_id</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="DigitizedWork.clean"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add custom validation to trigger a save error in the admin</span>
<span class="sd">        if someone tries to unsuppress a record that has been suppressed</span>
<span class="sd">        (not yet supported).&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPRESSED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;Unsuppressing records not yet supported.&#39;</span><span class="p">)</span>

        <span class="c1"># should not be editable in admin, but add a validation check</span>
        <span class="c1"># just in case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s1">&#39;source_id&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">HATHI</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;Changing source ID for HathiTrust records is not supported&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="DigitizedWork.compare_protected_fields"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.compare_protected_fields">[docs]</a>    <span class="k">def</span> <span class="nf">compare_protected_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_obj</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Compare protected fields in a</span>
<span class="sd">        :class:`ppa.archive.models.DigitizedWork` instance and return those</span>
<span class="sd">        that are changed.</span>

<span class="sd">        :param object db_obj: Database instance of a</span>
<span class="sd">            :class:`~ppa.archive.models.DigitizedWork`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">changed_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># if a field has changed, append to changed fields</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ProtectedWorkFieldFlags</span><span class="o">.</span><span class="n">all_flags</span><span class="p">:</span>
            <span class="c1"># field is in format of ProtectedWorkFieldFlags.title</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="c1"># if obj has a different value for a protected field</span>
            <span class="c1"># than its db counterpart</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">db_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
                <span class="c1"># append as a now protected field</span>
                <span class="n">changed_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">changed_fields</span></div>

<div class="viewcode-block" id="DigitizedWork.populate_fields"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.populate_fields">[docs]</a>    <span class="k">def</span> <span class="nf">populate_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Conditionally update fields as protected by flags using Hathi</span>
<span class="sd">        bibdata information.</span>

<span class="sd">        :param dict field_data: A dictionary of fields updated from a</span>
<span class="sd">            :class:`ppa.archive.hathi.HathiBibliographicRecord` instance.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">protected_fields</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protected_fields</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">field_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protected_fields</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="DigitizedWork.populate_from_bibdata"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.populate_from_bibdata">[docs]</a>    <span class="k">def</span> <span class="nf">populate_from_bibdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bibdata</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update record fields based on Hathi bibdata information.</span>
<span class="sd">        Full record is required in order to set all fields</span>

<span class="sd">        :param bibdata: bibliographic data returned from HathiTrust</span>
<span class="sd">            as instance of :class:`ppa.archive.hathi.HathiBibliographicRecord`</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># create dictionary to store bibliographic information</span>
        <span class="n">field_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># store hathi record id</span>
        <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;record_id&#39;</span><span class="p">]</span><span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">record_id</span>

        <span class="c1"># set fields from marc if available, since it has more details</span>
        <span class="k">if</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">marcxml</span><span class="p">:</span>
            <span class="c1"># set title and subtitle from marc if possible</span>
            <span class="c1"># - clean title: strip trailing space &amp; slash and initial bracket</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">marcxml</span><span class="p">[</span><span class="s1">&#39;245&#39;</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39; /&#39;</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)</span>

            <span class="c1"># according to PUL CAMS,</span>
            <span class="c1"># 245 subfield contains the subtitle *if* the preceding field</span>
            <span class="c1"># ends with a colon. (Otherwise could be a parallel title,</span>
            <span class="c1"># e.g. title in another language).</span>
            <span class="c1"># HOWEVER: metadata from Hathi doesn&#39;t seem to follow this</span>
            <span class="c1"># pattern (possibly due to records being older?)</span>

            <span class="c1"># subfields is a list of code, value, code, value</span>
            <span class="c1"># iterate in paired steps of two starting with first and second</span>
            <span class="c1"># for code, value in zip(bibdata.marcxml[&#39;245&#39;].subfields[0::2],</span>
            <span class="c1">#                        bibdata.marcxml[&#39;245&#39;].subfields[1::2]):</span>
            <span class="c1">#     if code == &#39;b&#39;:</span>
            <span class="c1">#         break</span>
            <span class="c1">#     preceding_character = value[-1:]</span>

            <span class="c1"># if preceding_character == &#39;:&#39;:</span>
            <span class="c1">#     self.subtitle = bibdata.marcxml[&#39;245&#39;][&#39;b&#39;] or &#39;&#39;</span>
            <span class="c1"># NOTE: skipping preceding character check for now</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">marcxml</span><span class="p">[</span><span class="s1">&#39;245&#39;</span><span class="p">][</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
                <span class="c1"># strip trailing space &amp; slash from subtitle</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;subtitle&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39; /&#39;</span><span class="p">)</span>
            <span class="c1"># indicator 2 provides the number of characters to be</span>
            <span class="c1"># skipped when sorting (could be 0)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">non_sort</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bibdata</span><span class="o">.</span><span class="n">marcxml</span><span class="p">[</span><span class="s1">&#39;245&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c1"># at least one record has a space here instead of a number</span>
                <span class="c1"># probably a data error, but handle it</span>
                <span class="c1"># - assuming no non-sort characters</span>
                <span class="n">non_sort</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># strip whitespace, since a small number of records have a</span>
            <span class="c1"># nonsort value that doesn&#39;t include a space after a</span>
            <span class="c1"># definite article.</span>
            <span class="c1"># Also strip punctuation, since MARC only includes it in</span>
            <span class="c1"># non-sort count when there is a definite article.</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;sort_title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">marcxml</span><span class="o">.</span><span class="n">title</span><span class="p">()[</span><span class="n">non_sort</span><span class="p">:]</span>\
                    <span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &quot;[&#39;</span><span class="p">)</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">marcxml</span><span class="o">.</span><span class="n">author</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
            <span class="c1"># remove a note present on some records and strip whitespace</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[from old catalog]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># removing trailing period, except when it is part of an</span>
            <span class="c1"># initial or known abbreviation (i.e, Esq.)</span>
            <span class="c1"># Look for single initial, but support initials with no spaces</span>
            <span class="k">if</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> \
            <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;( ([A-Z]\.)*[A-Z]| Esq)\.$&#39;</span><span class="p">,</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]):</span>
                <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;author&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>

            <span class="c1"># field 260 includes publication information</span>
            <span class="k">if</span> <span class="s1">&#39;260&#39;</span> <span class="ow">in</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">marcxml</span><span class="p">:</span>
                <span class="c1"># strip trailing punctuation from publisher and pub place</span>
                <span class="c1"># subfield $a is place of publication</span>
                <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;pub_place&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">marcxml</span><span class="p">[</span><span class="s1">&#39;260&#39;</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
                <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;pub_place&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;pub_place&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;;:,&#39;</span><span class="p">)</span>
                <span class="c1"># if place is marked as unknown (&quot;sine loco&quot;), leave empty</span>
                <span class="k">if</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;pub_place&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;[s.l.]&#39;</span><span class="p">:</span>
                    <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;pub_place&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="c1"># subfield $b is name of publisher</span>
                <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">marcxml</span><span class="p">[</span><span class="s1">&#39;260&#39;</span><span class="p">][</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
                <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;;:,&#39;</span><span class="p">)</span>
                <span class="c1"># if publisher is marked as unknown (&quot;sine nomine&quot;), leave empty</span>
                <span class="k">if</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;[s.n.]&#39;</span><span class="p">:</span>
                    <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="c1"># remove printed by statement before publisher name</span>
                <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">printed_by_re</span><span class="p">,</span>
                    <span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">],</span>
                    <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
                <span class="p">)</span>

            <span class="c1"># maybe: consider getting volume &amp; series directly from</span>
            <span class="c1"># marc rather than relying on hathi enumcron ()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># fallback behavior, if marc is not availiable</span>
            <span class="c1"># use dublin core title</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">title</span>
            <span class="c1"># could guess at non-sort, but hopefully unnecessary</span>

        <span class="c1"># NOTE: might also want to store sort title</span>
        <span class="c1"># pub date returned in api JSON is list; use first for now (if available)</span>
        <span class="k">if</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">pub_dates</span><span class="p">:</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;pub_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">pub_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">copy_details</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">copy_details</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
        <span class="c1"># hathi version/volume information for this specific copy of a work</span>
        <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;enumcron&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy_details</span><span class="p">[</span><span class="s1">&#39;enumcron&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="c1"># hathi source url can currently be inferred from htid, but is</span>
        <span class="c1"># included in the bibdata in case it changes - so let&#39;s just store it</span>
        <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;source_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy_details</span><span class="p">[</span><span class="s1">&#39;itemURL&#39;</span><span class="p">]</span>

        <span class="c1"># remove brackets around inferred publishers, place of publication</span>
        <span class="c1"># *only* if they wrap the whole text</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;publisher&#39;</span><span class="p">,</span> <span class="s1">&#39;pub_place&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_data</span><span class="p">:</span>
                <span class="n">field_data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^\[(.*)\]$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1&#39;</span><span class="p">,</span> <span class="n">field_data</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>

        <span class="c1"># should also consider storing:</span>
        <span class="c1"># - last update, rights code / rights string, item url</span>
        <span class="c1"># (maybe solr only?)</span>

        <span class="c1"># conditionally update fields that are protected (or not)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_fields</span><span class="p">(</span><span class="n">field_data</span><span class="p">)</span></div>


    <span class="n">index_depends_on</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;collections&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;save&#39;</span><span class="p">:</span> <span class="n">CollectionSignalHandlers</span><span class="o">.</span><span class="n">save</span><span class="p">,</span>
            <span class="s1">&#39;delete&#39;</span><span class="p">:</span> <span class="n">CollectionSignalHandlers</span><span class="o">.</span><span class="n">delete</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

<div class="viewcode-block" id="DigitizedWork.index_id"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.index_id">[docs]</a>    <span class="k">def</span> <span class="nf">index_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;source id is used as solr identifier&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span></div>

<div class="viewcode-block" id="DigitizedWork.index_data"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.index_data">[docs]</a>    <span class="k">def</span> <span class="nf">index_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;data for indexing in Solr&#39;&#39;&#39;</span>

        <span class="c1"># When an item has been suppressed, return id only.</span>
        <span class="c1"># This will blank out any previously indexed values, and item</span>
        <span class="c1"># will not be findable by any public searchable fields.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPRESSED</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">}</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span>
            <span class="s1">&#39;source_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span>
            <span class="s1">&#39;source_url&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_url</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="s1">&#39;subtitle&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtitle</span><span class="p">,</span>
            <span class="s1">&#39;sort_title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_title</span><span class="p">,</span>
            <span class="s1">&#39;pub_date&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pub_date</span><span class="p">,</span>
            <span class="s1">&#39;pub_place&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pub_place</span><span class="p">,</span>
            <span class="s1">&#39;publisher&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="p">,</span>
            <span class="s1">&#39;enumcron&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumcron</span><span class="p">,</span>
            <span class="s1">&#39;author&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
            <span class="c1"># set default value to simplify queries to find uncollected items</span>
            <span class="c1"># (not set in Solr schema because needs to be works only)</span>
            <span class="s1">&#39;collections&#39;</span><span class="p">:</span>
                <span class="p">[</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                <span class="k">else</span> <span class="p">[</span><span class="n">NO_COLLECTION_LABEL</span><span class="p">],</span>
            <span class="c1"># public notes field for display on site_name</span>
            <span class="s1">&#39;notes&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">public_notes</span><span class="p">,</span>
            <span class="c1"># hard-coded to distinguish from &amp; sort with pages</span>
            <span class="s1">&#39;item_type&#39;</span><span class="p">:</span> <span class="s1">&#39;work&#39;</span><span class="p">,</span>
            <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="DigitizedWork.count_pages"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.count_pages">[docs]</a>    <span class="k">def</span> <span class="nf">count_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ptree_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Count the number of pages for a digitized work based on the</span>
<span class="sd">        number of files in the zipfile within the pairtree content.</span>
<span class="sd">        Raises :class:`pairtree.storage_exceptions.ObjectNotFoundException`</span>
<span class="sd">        if the data is not found in the pairtree storage. Returns page count</span>
<span class="sd">        found; saves the object if the count changes.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ptree_client</span><span class="p">:</span>
            <span class="n">ptree_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hathi</span><span class="o">.</span><span class="n">pairtree_client</span><span class="p">()</span>

        <span class="c1"># count the files in the zipfile</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># could raise pairtree exception, but allow calling context to catch</span>
        <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hathi</span><span class="o">.</span><span class="n">zipfile_path</span><span class="p">(</span><span class="n">ptree_client</span><span class="p">))</span> <span class="k">as</span> <span class="n">ht_zip</span><span class="p">:</span>
            <span class="c1"># some aggregate packages retrieved from Data API</span>
            <span class="c1"># include jp2 and xml files as well as txt; only count text</span>
            <span class="n">page_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">filename</span> <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">ht_zip</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
                              <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">)])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Counted </span><span class="si">%d</span><span class="s1"> pages in zipfile in </span><span class="si">%f</span><span class="s1"> sec&#39;</span><span class="p">,</span>
                         <span class="n">page_count</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
        <span class="c1"># NOTE: could also count pages via mets file, but that&#39;s slower</span>
        <span class="c1"># than counting via zipfile name list</span>

        <span class="c1"># store page count in the database if changed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_count</span> <span class="o">!=</span> <span class="n">page_count</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">page_count</span> <span class="o">=</span> <span class="n">page_count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">page_count</span></div>

<div class="viewcode-block" id="DigitizedWork.page_index_data"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.page_index_data">[docs]</a>    <span class="k">def</span> <span class="nf">page_index_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get page content for this work from Hathi pairtree and return</span>
<span class="sd">        data to be indexed in solr.&#39;&#39;&#39;</span>

        <span class="c1"># If an item has been suppressed or is from a source other than</span>
        <span class="c1"># hathi, bail out. No pages to index.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_suppressed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">HATHI</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># load mets record to pull metadata about the images</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mmets</span> <span class="o">=</span> <span class="n">load_xmlobject_from_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hathi</span><span class="o">.</span><span class="n">metsfile_path</span><span class="p">(),</span>
                                             <span class="n">MinimalMETS</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">storage_exceptions</span><span class="o">.</span><span class="n">ObjectNotFoundException</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Pairtree data for </span><span class="si">%s</span><span class="s1"> not found but status is </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_status_display</span><span class="p">())</span>
            <span class="k">return</span>

        <span class="c1"># read zipfile contents in place, without unzipping</span>
        <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hathi</span><span class="o">.</span><span class="n">zipfile_path</span><span class="p">())</span> <span class="k">as</span> <span class="n">ht_zip</span><span class="p">:</span>

            <span class="c1"># yield a generator of index data for each page; iterate</span>
            <span class="c1"># over pages in METS structmap</span>
            <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">mmets</span><span class="o">.</span><span class="n">structmap_pages</span><span class="p">:</span>
                <span class="c1"># zipfile spec uses / for path regardless of OS</span>
                <span class="n">pagefilename</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">hathi</span><span class="o">.</span><span class="n">content_dir</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">text_file_location</span><span class="p">])</span>
                <span class="k">with</span> <span class="n">ht_zip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pagefilename</span><span class="p">)</span> <span class="k">as</span> <span class="n">pagefile</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="p">{</span>
                            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">text_file</span><span class="o">.</span><span class="n">sequence</span><span class="p">),</span>
                            <span class="s1">&#39;source_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span>   <span class="c1"># for grouping with work record</span>
                            <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">pagefile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
                            <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">order</span><span class="p">,</span>
                            <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">display_label</span><span class="p">,</span>
                            <span class="s1">&#39;tags&#39;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">page</span><span class="o">.</span><span class="n">label</span> <span class="k">else</span> <span class="p">[],</span>
                            <span class="s1">&#39;item_type&#39;</span><span class="p">:</span> <span class="s1">&#39;page&#39;</span>
                        <span class="p">}</span>
                    <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                        <span class="k">return</span></div>

<div class="viewcode-block" id="DigitizedWork.get_metadata"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.get_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata_format</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get metadata for this item in the specified format.</span>
<span class="sd">        Currently only supports marc.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">metadata_format</span> <span class="o">==</span> <span class="s1">&#39;marc&#39;</span><span class="p">:</span>
            <span class="c1"># get metadata from hathi bib api and serialize</span>
            <span class="c1"># as binary marc</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">HATHI</span><span class="p">:</span>
                <span class="n">bib_api</span> <span class="o">=</span> <span class="n">HathiBibliographicAPI</span><span class="p">()</span>
                <span class="n">bibdata</span> <span class="o">=</span> <span class="n">bib_api</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="s1">&#39;htid&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">marcxml</span><span class="o">.</span><span class="n">as_marc</span><span class="p">()</span>

            <span class="c1"># TBD: can we get MARC records from oclc?</span>
            <span class="c1"># or should we generate dublin core from db metadata?</span>

            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># error for unknown</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported format </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metadata_format</span><span class="p">)</span></div>

<div class="viewcode-block" id="DigitizedWork.add_from_hathi"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.add_from_hathi">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_from_hathi</span><span class="p">(</span><span class="n">htid</span><span class="p">,</span> <span class="n">bib_api</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">get_data</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log_msg_src</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add or update a HathiTrust work in the database.</span>
<span class="sd">        Retrieves bibliographic data from Hathi api, retrieves or creates</span>
<span class="sd">        a :class:`DigitizedWork` record, and populates the metadata if</span>
<span class="sd">        this is a new record, if the Hathi metadata has changed, or</span>
<span class="sd">        if update is requested. Creates admin log entry to document</span>
<span class="sd">        record creation or update.  If `get_data` is specified,</span>
<span class="sd">        will retrieve structure and aggregate data from Hathi Data API</span>
<span class="sd">        and add it to the local pairtree datastore.</span>

<span class="sd">        Raises :class:`ppa.archive.hathi.HathiItemNotFound` for invalid</span>
<span class="sd">        id.</span>

<span class="sd">        Returns the new or updated  :class:`~ppa.archive.models.DigitizedWork`.</span>

<span class="sd">        :param htid: HathiTrust record identifier</span>
<span class="sd">        :param bib_api: optional :class:`~ppa.archive.hathi.HathiBibliographicAPI`</span>
<span class="sd">            instance, to allow for shared sessions in scripts</span>
<span class="sd">        :param update: update bibliographic metadata even if the hathitrust</span>
<span class="sd">            record is not newer than the local database record (default: False)</span>
<span class="sd">        :param get_data: retrieve content data from Data API; for new</span>
<span class="sd">            records only (default: False)</span>
<span class="sd">        :param log_msg_src: source of the change to be used included</span>
<span class="sd">            in log entry messages (optional). Will be used as &quot;Created/updated</span>
<span class="sd">            [log_msg_src]&quot;.</span>
<span class="sd">        :param user: optional user responsible for the change,</span>
<span class="sd">            to be associated with :class:`~django.admin.models.LogEntry`</span>
<span class="sd">            record</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># initialize new bibliographic API if none is passed in</span>
        <span class="n">bib_api</span> <span class="o">=</span> <span class="n">bib_api</span> <span class="ow">or</span> <span class="n">HathiBibliographicAPI</span><span class="p">()</span>

        <span class="c1"># set a default log message source if not specified</span>
        <span class="n">log_msg_src</span> <span class="o">=</span> <span class="n">log_msg_src</span> <span class="ow">or</span> <span class="s1">&#39;from HathiTrust bibliographic data&#39;</span>

        <span class="c1"># get bibliographic data for this record from Hathi api</span>
        <span class="c1"># - needed to check if update is required for existing records,</span>
        <span class="c1">#   and to populate metadata for new records</span>

        <span class="c1"># could raise HathiItemNotFound for invalid id</span>
        <span class="n">bibdata</span> <span class="o">=</span> <span class="n">bib_api</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="s1">&#39;htid&#39;</span><span class="p">,</span> <span class="n">htid</span><span class="p">)</span>

        <span class="c1"># if hathi id is valid and we have bibliographic data, create</span>
        <span class="c1"># a new record</span>

        <span class="c1"># find existing record or create a new one</span>
        <span class="n">digwork</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">source_id</span><span class="o">=</span><span class="n">htid</span><span class="p">)</span>

        <span class="c1"># get configured script user for log entries if no user passed in</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SCRIPT_USERNAME</span><span class="p">)</span>

        <span class="c1"># if this is an existing record, check if updates are needed</span>
        <span class="n">source_updated</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">created</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">source_updated</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">copy_last_updated</span><span class="p">(</span><span class="n">htid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">digwork</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">source_updated</span><span class="p">:</span>
                <span class="c1"># local copy is newer than last source modification date</span>
                <span class="c1"># and update is not requested; return un modified</span>
                <span class="k">return</span> <span class="n">digwork</span>

        <span class="c1"># populate digitized item in the database</span>
        <span class="n">digwork</span><span class="o">.</span><span class="n">populate_from_bibdata</span><span class="p">(</span><span class="n">bibdata</span><span class="p">)</span>
        <span class="n">digwork</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># create a log entry to document record creation or change</span>
        <span class="c1"># if created, action is addition and message is creation</span>
        <span class="n">log_change_message</span> <span class="o">=</span> <span class="s1">&#39;Created </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">log_msg_src</span>
        <span class="n">log_action</span> <span class="o">=</span> <span class="n">ADDITION</span>
        <span class="c1"># if this was not a new record, log as an update</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">created</span><span class="p">:</span>
            <span class="c1"># create log entry for updating an existing record</span>
            <span class="c1"># include details about why the update happened if possible</span>
            <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
                <span class="n">msg_detail</span> <span class="o">=</span> <span class="s1">&#39; (forced update)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg_detail</span> <span class="o">=</span> <span class="s1">&#39;; source record last updated </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">source_updated</span>
            <span class="n">log_change_message</span> <span class="o">=</span> <span class="s1">&#39;Updated </span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">log_msg_src</span><span class="p">,</span> <span class="n">msg_detail</span><span class="p">)</span>
            <span class="n">log_action</span> <span class="o">=</span> <span class="n">CHANGE</span>

        <span class="c1"># create log entry for record creation</span>
        <span class="n">LogEntry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">log_action</span><span class="p">(</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">content_type_id</span><span class="o">=</span><span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">digwork</span><span class="p">)</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="n">object_id</span><span class="o">=</span><span class="n">digwork</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="n">object_repr</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">digwork</span><span class="p">),</span>
            <span class="n">change_message</span><span class="o">=</span><span class="n">log_change_message</span><span class="p">,</span>
            <span class="n">action_flag</span><span class="o">=</span><span class="n">log_action</span><span class="p">)</span>

        <span class="c1"># get data if requested and if this was a new record</span>
        <span class="k">if</span> <span class="n">get_data</span> <span class="ow">and</span> <span class="n">created</span><span class="p">:</span>
            <span class="n">digwork</span><span class="o">.</span><span class="n">get_hathi_data</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">digwork</span></div>

<div class="viewcode-block" id="DigitizedWork.get_hathi_data"><a class="viewcode-back" href="../../../codedocs.html#ppa.archive.models.DigitizedWork.get_hathi_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_hathi_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Use Data API to fetch zipfile and mets and add them to the</span>
<span class="sd">        local pairtree. Intended for use with newly added HathiTrust</span>
<span class="sd">        records not imported from local pairtree data.</span>

<span class="sd">        Raises :class:`~ppa.archive.hathi.HathiItemNotFound` for invalid</span>
<span class="sd">        id and :class:`~ppa.archive.hathi.HathiItemForbidden` for a</span>
<span class="sd">        valid record that configured Data API credentials do not allow</span>
<span class="sd">        accessing.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># do nothing for non-hathi records</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">!=</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">HATHI</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">data_api</span> <span class="o">=</span> <span class="n">HathiDataAPI</span><span class="p">()</span>

        <span class="c1"># get pairtree client object for this item, creating if necessary</span>
        <span class="n">ptree_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hathi</span><span class="o">.</span><span class="n">pairtree_object</span><span class="p">(</span><span class="n">create</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># retrieve mets xml and add to pairtree</span>
        <span class="n">mets_response</span> <span class="o">=</span> <span class="n">data_api</span><span class="o">.</span><span class="n">get_structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
        <span class="c1"># use filename provided by Hathi in response headers</span>
        <span class="n">mets_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mets_response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;content-disposition&#39;</span><span class="p">])</span>
        <span class="c1"># file should be under content directory named by hathi id</span>
        <span class="n">mets_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hathi</span><span class="o">.</span><span class="n">content_dir</span><span class="p">,</span>
                                     <span class="n">mets_filename</span><span class="p">)</span>
        <span class="n">ptree_obj</span><span class="o">.</span><span class="n">add_bytestream_by_path</span><span class="p">(</span><span class="n">mets_filename</span><span class="p">,</span> <span class="n">mets_response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="c1"># get zip file and add to pairtree</span>
        <span class="n">data_response</span> <span class="o">=</span> <span class="n">data_api</span><span class="o">.</span><span class="n">get_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data_response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;content-disposition&#39;</span><span class="p">])</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">data_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;filename=&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hathi</span><span class="o">.</span><span class="n">content_dir</span><span class="p">,</span>
                                     <span class="n">data_filename</span><span class="p">)</span>
        <span class="n">ptree_obj</span><span class="o">.</span><span class="n">add_bytestream_by_path</span><span class="p">(</span><span class="n">data_filename</span><span class="p">,</span> <span class="n">data_response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>

        <span class="c1"># count pages now that data is present (required for indexing)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count_pages</span><span class="p">()</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Princeton Prosody Archive</a></h1>



<p class="blurb">Django web application for "Princeton Prosody Archive" CDH project</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Princeton-CDH&repo=ppa-django&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/Princeton-CDH/ppa-django">
    <img
        alt="https://secure.travis-ci.org/Princeton-CDH/ppa-django.svg?branch=master"
        src="https://secure.travis-ci.org/Princeton-CDH/ppa-django.svg?branch=master"
    />
</a>
</p>




    

<p>
<a class="badge" href="https://codecov.io/github/Princeton-CDH/ppa-django">
    <img
    alt="https://codecov.io/github/Princeton-CDH/ppa-django/coverage.svg?branch=master"
    src="https://codecov.io/github/Princeton-CDH/ppa-django/coverage.svg?branch=master"
    />
</a>
</p>
<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../codedocs.html">Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deploynotes.html">Deploy Notes</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><div class="powered_by">
<p>Powered by:</p>
<a href="http://cdh.princeton.edu/">
<img src="https://cdh.princeton.edu/static/img/logos/cdh-logo.svg"
    alt="Center for Digital Humanities @ Princeton" />
</a>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, CDH @ Princeton University.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>