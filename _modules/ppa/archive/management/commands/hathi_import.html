<!DOCTYPE html>

<html lang="en" data-content_root="../../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ppa.archive.management.commands.hathi_import &#8212; Princeton Prosody Archive 3.15.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../../../_static/documentation_options.js?v=31597fc9"></script>
    <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ppa.archive.management.commands.hathi_import</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">**hathi_import** is a custom manage command for bulk import of HathiTrust</span>
<span class="sd">materials into the local database for management.  It does *not* index</span>
<span class="sd">into Solr for search and browse; use the **index** script for that after</span>
<span class="sd">import.</span>

<span class="sd">This script expects a local copy of dataset files in pairtree format</span>
<span class="sd">retrieved by rsync.  (Note that pairtree data must include pairtree</span>
<span class="sd">version file to be valid.)</span>

<span class="sd">Contents are inspected from the configured **HATHI_DATA** path;</span>
<span class="sd">:class:`~ppa.archive.models.DigitizedWork` records are created or updated</span>
<span class="sd">based on identifiers found and metadata retrieved from the HathiTrust</span>
<span class="sd">Bibliographic API.  Page content is only reflected in the database</span>
<span class="sd">via a total page count per work (but page contents will be indexed in</span>
<span class="sd">Solr via **index** script).</span>

<span class="sd">By default, existing records are updated only when the Hathi record has changed</span>
<span class="sd">or if requested via `--update`` script option.</span>

<span class="sd">Supports importing specific items by hathi id, but the pairtree content</span>
<span class="sd">for the items still must exist at the configured path.</span>

<span class="sd">Example usage::</span>

<span class="sd">    # import everything with defaults</span>
<span class="sd">    python manage.py hathi_import</span>
<span class="sd">    # import specific items</span>
<span class="sd">    python manage.py hathi_import htid1 htid2 htid3</span>
<span class="sd">    # re-import and update records</span>
<span class="sd">    python manage.py hathi_import --update</span>
<span class="sd">    # display progressbar to show status and ETA</span>
<span class="sd">    python manage.py hathi_import -v 0 --progress</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">glob</span><span class="w"> </span><span class="kn">import</span> <span class="n">glob</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">progressbar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.admin.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADDITION</span><span class="p">,</span> <span class="n">CHANGE</span><span class="p">,</span> <span class="n">LogEntry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.contenttypes.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContentType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.management.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseCommand</span><span class="p">,</span> <span class="n">CommandError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.template.defaultfilters</span><span class="w"> </span><span class="kn">import</span> <span class="n">pluralize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.timezone</span><span class="w"> </span><span class="kn">import</span> <span class="n">now</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pairtree</span><span class="w"> </span><span class="kn">import</span> <span class="n">pairtree_client</span><span class="p">,</span> <span class="n">storage_exceptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">parasolr.django.signals</span><span class="w"> </span><span class="kn">import</span> <span class="n">IndexableSignalHandler</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ppa.archive.hathi</span><span class="w"> </span><span class="kn">import</span> <span class="n">HathiBibliographicAPI</span><span class="p">,</span> <span class="n">HathiItemNotFound</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ppa.archive.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">DigitizedWork</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Command">
<a class="viewcode-back" href="../../../../../codedocs.html#ppa.archive.management.commands.hathi_import.Command">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Import HathiTrust digitized items into PPA to be managed and searched&quot;&quot;&quot;</span>

    <span class="n">help</span> <span class="o">=</span> <span class="vm">__doc__</span>

    <span class="n">bib_api</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">hathi_pairtree</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#: normal verbosity level</span>
    <span class="n">v_normal</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">verbosity</span> <span class="o">=</span> <span class="n">v_normal</span>

<div class="viewcode-block" id="Command.add_arguments">
<a class="viewcode-back" href="../../../../../codedocs.html#ppa.archive.management.commands.hathi_import.Command.add_arguments">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parser</span><span class="p">):</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;htids&quot;</span><span class="p">,</span>
            <span class="n">nargs</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Optional list of specific volumes to import by HathiTrust id.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;-u&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--update&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Update local content even if source record has not changed.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
            <span class="s2">&quot;--progress&quot;</span><span class="p">,</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store_true&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Display a progress bar to track the status of the import.&quot;</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Command.handle">
<a class="viewcode-back" href="../../../../../codedocs.html#ppa.archive.management.commands.hathi_import.Command.handle">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># disconnect signal handler for on-demand indexing, for efficiency</span>
        <span class="c1"># (index in bulk after an update, not one at a time)</span>
        <span class="n">IndexableSignalHandler</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bib_api</span> <span class="o">=</span> <span class="n">HathiBibliographicAPI</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;verbosity&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_normal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">digwork_content_type</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">DigitizedWork</span><span class="p">)</span>

        <span class="c1"># bulk import only for now</span>
        <span class="c1"># - eventually support list of ids + rsync?</span>

        <span class="c1"># for now, start with existing rsync data</span>
        <span class="c1"># - get list of ids, rsync data, grab metadata</span>
        <span class="c1"># - populate database only (does not index in solr); if a work</span>
        <span class="c1">#   has already been imported, will only update if changed in hathi</span>
        <span class="c1">#   or update requested in script options</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># if ids are explicitly specified on the command line, only</span>
        <span class="c1"># index those items</span>
        <span class="c1"># (currently still requires rsync data to be present on the filesystem)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;htids&quot;</span><span class="p">]:</span>
            <span class="n">ids_to_import</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;htids&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids_to_import</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># otherwise, find and import everything in the pairtree data</span>
            <span class="n">ids_to_import</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hathi_ids</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_hathi_ids</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;progress&quot;</span><span class="p">]:</span>
            <span class="n">progbar</span> <span class="o">=</span> <span class="n">progressbar</span><span class="o">.</span><span class="n">ProgressBar</span><span class="p">(</span>
                <span class="n">redirect_stdout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">],</span> <span class="n">max_error</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">progbar</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># initialize access to rsync data as dict of pairtrees by prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_pairtrees</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">htid</span> <span class="ow">in</span> <span class="n">ids_to_import</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_normal</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">htid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">digwork</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_digitizedwork</span><span class="p">(</span><span class="n">htid</span><span class="p">)</span>
            <span class="c1"># if no item is returned, either there is an error or no update</span>
            <span class="c1"># is needed; update count and go to the next item</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">digwork</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">progbar</span><span class="p">:</span>
                    <span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="c1"># count pages in the pairtree zip file and update digwork page count</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;pages&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">digwork</span><span class="o">.</span><span class="n">count_pages</span><span class="p">()</span>
                <span class="c1"># update page count in the database</span>
                <span class="k">if</span> <span class="n">digwork</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s2">&quot;page_count&quot;</span><span class="p">):</span>
                    <span class="n">digwork</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="n">storage_exceptions</span><span class="o">.</span><span class="n">ObjectNotFoundException</span><span class="p">,</span>
                <span class="ne">IndexError</span><span class="p">,</span>
            <span class="p">):</span>  <span class="c1"># IndexError on filepath</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found in datastore&quot;</span> <span class="o">%</span> <span class="n">digwork</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">progbar</span><span class="p">:</span>
                <span class="n">progbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">])</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Processed </span><span class="si">{:,d}</span><span class="s2"> item</span><span class="si">{}</span><span class="s2"> for import.&quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Added </span><span class="si">{:,d}</span><span class="s2">; updated </span><span class="si">{:,d}</span><span class="s2">; skipped </span><span class="si">{:,d}</span><span class="s2">; &quot;</span>
            <span class="o">+</span> <span class="s2">&quot;</span><span class="si">{:,d}</span><span class="s2"> error</span><span class="si">{}</span><span class="s2">; imported </span><span class="si">{:,d}</span><span class="s2"> page</span><span class="si">{}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
        <span class="n">summary</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">],</span>
            <span class="n">pluralize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;updated&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;skipped&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">],</span>
            <span class="n">pluralize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;pages&quot;</span><span class="p">],</span>
            <span class="n">pluralize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;pages&quot;</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span></div>


<div class="viewcode-block" id="Command.initialize_pairtrees">
<a class="viewcode-back" href="../../../../../codedocs.html#ppa.archive.management.commands.hathi_import.Command.initialize_pairtrees">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize_pairtrees</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize pairtree storage clients for each</span>
<span class="sd">        subdirectory in the configured **HATHI_DATA** path.&quot;&quot;&quot;</span>

        <span class="c1"># if the configured directory does not exist or is not</span>
        <span class="c1"># a directory, bail out</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">HATHI_DATA</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">CommandError</span><span class="p">(</span>
                <span class="s2">&quot;Configuration error for HATHI_DATA dir (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">HATHI_DATA</span>
            <span class="p">)</span>

        <span class="c1"># HathiTrust data is constructed with instutition short name</span>
        <span class="c1"># with pairtree root underneath each</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hathi_pairtree</span><span class="p">:</span>
            <span class="n">hathi_dirs</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">HATHI_DATA</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ht_data_dir</span> <span class="ow">in</span> <span class="n">hathi_dirs</span><span class="p">:</span>
                <span class="c1"># ignore non-directories! this is useful because</span>
                <span class="c1"># the rsync may copy txt files, .DS_Store from Mac</span>
                <span class="c1"># may be in there, and so forth.</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ht_data_dir</span><span class="p">):</span>
                    <span class="n">prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ht_data_dir</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Initializing pair tree in (</span><span class="si">{</span><span class="n">ht_data_dir</span><span class="si">}</span><span class="s2">) [prefix=</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">]&quot;</span>
                    <span class="p">)</span>
                    <span class="n">hathi_ptree</span> <span class="o">=</span> <span class="n">pairtree_client</span><span class="o">.</span><span class="n">PairtreeStorageClient</span><span class="p">(</span>
                        <span class="n">prefix</span><span class="p">,</span> <span class="n">ht_data_dir</span>
                    <span class="p">)</span>
                    <span class="c1"># store initialized pairtree client by prefix for later use</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hathi_pairtree</span><span class="p">[</span><span class="n">prefix</span><span class="p">]</span> <span class="o">=</span> <span class="n">hathi_ptree</span></div>


<div class="viewcode-block" id="Command.get_hathi_ids">
<a class="viewcode-back" href="../../../../../codedocs.html#ppa.archive.management.commands.hathi_import.Command.get_hathi_ids">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_hathi_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generator of hathi ids from previously rsynced hathitrust data,</span>
<span class="sd">        based on the configured **HATHI_DATA** path in settings.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialize_pairtrees</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">hathi_ptree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hathi_pairtree</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">hathi_id</span> <span class="ow">in</span> <span class="n">hathi_ptree</span><span class="o">.</span><span class="n">list_ids</span><span class="p">():</span>
                <span class="c1"># NOTE: prefix should automatially be handled based on</span>
                <span class="c1"># pairtree_prefix, but python pairtree library doesn&#39;t</span>
                <span class="c1"># yet include logic for that</span>
                <span class="k">yield</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">hathi_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="Command.count_hathi_ids">
<a class="viewcode-back" href="../../../../../codedocs.html#ppa.archive.management.commands.hathi_import.Command.count_hathi_ids">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">count_hathi_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;count items in the pairtree structure without loading</span>
<span class="sd">        all into memory at once.&quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hathi_ids</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Counted hathi ids in </span><span class="si">%f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">count</span></div>


<div class="viewcode-block" id="Command.import_digitizedwork">
<a class="viewcode-back" href="../../../../../codedocs.html#ppa.archive.management.commands.hathi_import.Command.import_digitizedwork">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">import_digitizedwork</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">htid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Import a single work into the database.</span>
<span class="sd">        Retrieves bibliographic data from Hathi api. If the record already</span>
<span class="sd">        exists in the database, it is only updated if the hathi record</span>
<span class="sd">        has changed or if an update is requested by the user.</span>
<span class="sd">        Creates admin log entry for record creation or record update.</span>
<span class="sd">        Returns None if there is an error retrieving bibliographic data</span>
<span class="sd">        or no update is needed; otherwise, returns the</span>
<span class="sd">        :class:`~ppa.archive.models.DigitizedWork`.&quot;&quot;&quot;</span>

        <span class="c1"># store the current time to find log entries created after</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">digwork</span> <span class="o">=</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">add_from_hathi</span><span class="p">(</span>
                <span class="n">htid</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bib_api</span><span class="p">,</span>
                <span class="n">update</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;update&quot;</span><span class="p">],</span>
                <span class="n">log_msg_src</span><span class="o">=</span><span class="s2">&quot;via hathi_import script&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">HathiItemNotFound</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Error: Bibliographic data not found for &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">htid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">MultipleObjectsReturned</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Error: Multiple entries found for &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">htid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span>

        <span class="c1"># check log entries for this record to determine what was done</span>
        <span class="n">log_entries</span> <span class="o">=</span> <span class="n">LogEntry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">content_type_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">digwork_content_type</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="n">object_id</span><span class="o">=</span><span class="n">digwork</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="n">action_time__gte</span><span class="o">=</span><span class="n">before</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># no log entry - nothing was done (not new, no update needed)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">log_entries</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="c1"># local copy is newer than last source modification date</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_normal</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s2">&quot;Source record last updated </span><span class="si">%s</span><span class="s2">, no update needed&quot;</span>
                    <span class="o">%</span> <span class="n">digwork</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="c1"># nothing to do; continue to next item</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;skipped&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="n">log_entries</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">action_flag</span> <span class="o">==</span> <span class="n">CHANGE</span><span class="p">:</span>
            <span class="c1"># report if record was changed and update not forced</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s2">&quot;update&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                    <span class="s2">&quot;Source record last updated </span><span class="si">%s</span><span class="s2">, update needed&quot;</span>
                    <span class="o">%</span> <span class="n">digwork</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="c1"># count the update</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;updated&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="n">log_entries</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">action_flag</span> <span class="o">==</span> <span class="n">ADDITION</span><span class="p">:</span>
            <span class="c1"># count the new record</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">digwork</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../../../index.html">
    <img class="logo" src="../../../../../_static/ppa_logo.png" alt="Logo" />
    
    <h1 class="logo logo-name">Princeton Prosody Archive</h1>
    
  </a>
</p>



<p class="blurb">Django web application for "Princeton Prosody Archive" CDH project</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Princeton-CDH&repo=ppa-django&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../codedocs.html">Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../deploynotes.html">Deploy Notes</a></li>
</ul>


<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><div class="powered_by">
<p>Powered by:</p>
<a href="http://cdh.princeton.edu/">
<img src="https://cdh.princeton.edu/static/img/CDH_logo.svg"
    alt="Center for Digital Humanities @ Princeton" />
</a>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, CDH @ Princeton University.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>