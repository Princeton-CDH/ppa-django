<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ppa.archive.views &#8212; Princeton Prosody Archive 3.15.0-dev documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../_static/documentation_options.js?v=7b7f12ef"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ppa.archive.views</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib</span><span class="w"> </span><span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.mixins</span><span class="w"> </span><span class="kn">import</span> <span class="n">PermissionRequiredMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">MultipleObjectsReturned</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.paginator</span><span class="w"> </span><span class="kn">import</span> <span class="n">Paginator</span><span class="p">,</span> <span class="n">PageNotAnInteger</span><span class="p">,</span> <span class="n">EmptyPage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Http404</span><span class="p">,</span>
    <span class="n">HttpResponsePermanentRedirect</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlencode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.generic</span><span class="w"> </span><span class="kn">import</span> <span class="n">DetailView</span><span class="p">,</span> <span class="n">ListView</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.generic.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">RedirectView</span><span class="p">,</span> <span class="n">TemplateView</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.generic.edit</span><span class="w"> </span><span class="kn">import</span> <span class="n">FormView</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">parasolr.django.views</span><span class="w"> </span><span class="kn">import</span> <span class="n">SolrLastModifiedMixin</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ppa.archive.forms</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AddToCollectionForm</span><span class="p">,</span>
    <span class="n">ImportForm</span><span class="p">,</span>
    <span class="n">SearchForm</span><span class="p">,</span>
    <span class="n">SearchWithinWorkForm</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ppa.archive.import_util</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaleImporter</span><span class="p">,</span> <span class="n">HathiImporter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ppa.archive.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">NO_COLLECTION_LABEL</span><span class="p">,</span> <span class="n">DigitizedWork</span><span class="p">,</span> <span class="n">SourceNote</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ppa.archive.solr</span><span class="w"> </span><span class="kn">import</span> <span class="n">ArchiveSearchQuerySet</span><span class="p">,</span> <span class="n">PageSearchQuerySet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ppa.common.views</span><span class="w"> </span><span class="kn">import</span> <span class="n">AjaxTemplateMixin</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="GracefulPaginator">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.GracefulPaginator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GracefulPaginator</span><span class="p">(</span><span class="n">Paginator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Paginator override to gracefully handle out-of-range errors.</span>
<span class="sd">    Adapted from https://forum.djangoproject.com/t/23037&quot;&quot;&quot;</span>

<div class="viewcode-block" id="GracefulPaginator.page">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.GracefulPaginator.page">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the page by the supplied number. Reset to 1 if the supplied page is out of range.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_number</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">PageNotAnInteger</span><span class="p">,</span> <span class="n">EmptyPage</span><span class="p">):</span>
            <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">number</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DigitizedWorkListView">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.DigitizedWorkListView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DigitizedWorkListView</span><span class="p">(</span><span class="n">AjaxTemplateMixin</span><span class="p">,</span> <span class="n">SolrLastModifiedMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Search and browse digitized works.  Based on Solr index</span>
<span class="sd">    of works and pages.&quot;&quot;&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">DigitizedWork</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;archive/digitizedwork_list.html&quot;</span>
    <span class="n">ajax_template_name</span> <span class="o">=</span> <span class="s2">&quot;archive/snippets/results_list.html&quot;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">SearchForm</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">paginator_class</span> <span class="o">=</span> <span class="n">GracefulPaginator</span>
    <span class="c1">#: title for metadata / preview</span>
    <span class="n">meta_title</span> <span class="o">=</span> <span class="s2">&quot;Princeton Prosody Archive&quot;</span>
    <span class="c1">#: page description for metadata/preview</span>
    <span class="n">meta_description</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;The Princeton Prosody Archive is a full-text</span>
<span class="s2">    searchable database of thousands of historical documents about the</span>
<span class="s2">    study of language and the study of poetry.&quot;&quot;&quot;</span>

    <span class="c1"># keyword query; assume no search terms unless set</span>
    <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># a bug used to allow aggregation of multiple cluster params,</span>
        <span class="c1"># which is not supported; if detected, redirect to archive search</span>
        <span class="n">cluster_param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cluster_param</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_param</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponsePermanentRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;archive:list&quot;</span><span class="p">))</span>
            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">303</span>  <span class="c1"># See other</span>
            <span class="k">return</span> <span class="n">response</span>

        <span class="c1"># otherwise, process response normally</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DigitizedWorkListView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="DigitizedWorkListView.paginate_queryset">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.DigitizedWorkListView.paginate_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">paginate_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">page_size</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Graceful paginate_queryset override to handle non-numeric inputs.</span>
<span class="sd">        Adapted from https://stackoverflow.com/a/61214021/394067&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">paginate_queryset</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">page_size</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Http404</span><span class="p">:</span>
            <span class="c1"># handle a 404, e.g. a non-numeric page number was entered</span>
            <span class="n">paginator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_paginator</span><span class="p">(</span>
                <span class="n">queryset</span><span class="p">,</span>
                <span class="n">page_size</span><span class="p">,</span>
                <span class="n">orphans</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_paginate_orphans</span><span class="p">(),</span>
                <span class="n">allow_empty_first_page</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_allow_empty</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">paginator</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">object_list</span><span class="p">,</span> <span class="n">page</span><span class="o">.</span><span class="n">has_other_pages</span><span class="p">())</span></div>


<div class="viewcode-block" id="DigitizedWorkListView.get_queryset">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.DigitizedWorkListView.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">form_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># if relevance sort is requested but there is no keyword search</span>
        <span class="c1"># term present, clear it out and fallback to default sort</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">()</span><span class="o">.</span><span class="n">has_keyword_query</span><span class="p">(</span><span class="n">form_opts</span><span class="p">):</span>
            <span class="k">if</span> <span class="s2">&quot;sort&quot;</span> <span class="ow">in</span> <span class="n">form_opts</span> <span class="ow">and</span> <span class="n">form_opts</span><span class="p">[</span><span class="s2">&quot;sort&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;relevance&quot;</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">form_opts</span><span class="p">[</span><span class="s2">&quot;sort&quot;</span><span class="p">]</span>

        <span class="n">searchform_defaults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="o">.</span><span class="n">defaults</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">searchform_defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># set as list to avoid nested lists</span>
            <span class="c1"># follows solution using in derrida-django for InstanceListView</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">form_opts</span><span class="o">.</span><span class="n">setlistdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">form_opts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="c1"># NOTE: Default sort for keyword search should be relevance but</span>
        <span class="c1"># currently no way to distinguish default sort from user selected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">(</span><span class="n">form_opts</span><span class="p">)</span>

        <span class="c1"># if the form is not valid, return an empty queryset and bail out</span>
        <span class="c1"># (queryset needed for django paginator)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>

        <span class="n">solr_q</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ArchiveSearchQuerySet</span><span class="p">()</span>
            <span class="o">.</span><span class="n">facet</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">facet_fields</span><span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get_solr_sort_field</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="c1"># components of query to filter digitized works</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">search_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">search_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">collections</span> <span class="o">=</span> <span class="n">search_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;collections&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">cluster_id</span> <span class="o">=</span> <span class="n">search_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">solr_q</span><span class="o">.</span><span class="n">keyword_search</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cluster_id</span><span class="p">:</span>
                <span class="c1"># filter by group id if set</span>
                <span class="n">solr_q</span> <span class="o">=</span> <span class="n">solr_q</span><span class="o">.</span><span class="n">within_cluster</span><span class="p">(</span><span class="n">cluster_id</span><span class="p">)</span>

            <span class="c1"># restrict by collection</span>
            <span class="k">if</span> <span class="n">collections</span><span class="p">:</span>
                <span class="c1"># if *all* collections are selected, there is no need to filter</span>
                <span class="c1"># (will return everything either way; keep the query simpler)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">collections</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;collections&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span><span class="p">):</span>
                    <span class="c1"># add quotes so solr will treat as exact phrase</span>
                    <span class="c1"># for multiword collection names</span>
                    <span class="n">solr_q</span><span class="o">.</span><span class="n">work_filter</span><span class="p">(</span>
                        <span class="n">collections_exact__in</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">]</span>
                    <span class="p">)</span>

            <span class="c1"># For collection exclusion logic to work properly, if no</span>
            <span class="c1"># collections are selected, no items should be returned.</span>
            <span class="c1"># This query should return no items but still provide facet</span>
            <span class="c1"># data to populate the collection filters on the form properly.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">solr_q</span><span class="o">.</span><span class="n">work_filter</span><span class="p">(</span><span class="n">collections_exact__exists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># filter books by title or author if there are search terms</span>
            <span class="n">solr_q</span><span class="o">.</span><span class="n">work_title_search</span><span class="p">(</span><span class="n">search_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">solr_q</span><span class="o">.</span><span class="n">work_filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">search_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">range_facet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">range_facets</span><span class="p">:</span>
            <span class="c1"># range filter requested in search options</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># if start or end is specified on the form, add a filter query</span>
            <span class="k">if</span> <span class="n">range_facet</span> <span class="ow">in</span> <span class="n">search_opts</span> <span class="ow">and</span> <span class="n">search_opts</span><span class="p">[</span><span class="n">range_facet</span><span class="p">]:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">search_opts</span><span class="p">[</span><span class="n">range_facet</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
                <span class="c1"># find works restricted by range</span>
                <span class="n">solr_q</span><span class="o">.</span><span class="n">work_filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">__range&quot;</span> <span class="o">%</span> <span class="n">range_facet</span><span class="p">:</span> <span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)})</span>

            <span class="c1"># get minimum and maximum pub date values from the db</span>
            <span class="n">pubmin</span><span class="p">,</span> <span class="n">pubmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">pub_date_minmax</span><span class="p">()</span>

            <span class="c1"># NOTE: hard-coded values are fallback logic for when</span>
            <span class="c1"># no contents are in the database and pubmin/pubmax are None</span>
            <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">if</span> <span class="n">start</span> <span class="k">else</span> <span class="n">pubmin</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="k">if</span> <span class="n">end</span> <span class="k">else</span> <span class="n">pubmax</span> <span class="ow">or</span> <span class="mi">1922</span>

            <span class="c1"># Configure range facet options specific to current field, to</span>
            <span class="c1"># support more than one range facet (even though not currently needed)</span>
            <span class="c1"># NOTE: per facet.range.include documentation, default behavior</span>
            <span class="c1"># is to include lower bound and exclude upper bound.</span>
            <span class="c1"># For simplicity, increase range end by one.</span>
            <span class="c1"># Calculate gap based start and end &amp; desired number of slices</span>
            <span class="c1"># ideally, generate 24 slices; minimum gap size of 1</span>
            <span class="c1"># Use hardend to restrict last range to *actual* maximum value</span>
            <span class="n">solr_q</span> <span class="o">=</span> <span class="n">solr_q</span><span class="o">.</span><span class="n">facet_range</span><span class="p">(</span>
                <span class="n">range_facet</span><span class="p">,</span>
                <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                <span class="n">end</span><span class="o">=</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">gap</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)),</span>
                <span class="n">hardend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solrq</span> <span class="o">=</span> <span class="n">solr_q</span>
        <span class="k">return</span> <span class="n">solr_q</span></div>


<div class="viewcode-block" id="DigitizedWorkListView.get_pages">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.DigitizedWorkListView.get_pages">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solrq</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If there is a keyword search, query Solr for matching pages</span>
<span class="sd">        with text highlighting.</span>
<span class="sd">        NOTE: This has to be done as a separate query because Solr</span>
<span class="sd">        doesn&#39;t support highlighting on collapsed items.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">solrq</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
            <span class="c1"># if there is no keyword query, bail out</span>
            <span class="k">return</span> <span class="p">({},</span> <span class="p">{})</span>

        <span class="c1"># work ids in solrq; quoting to handle ark ids</span>
        <span class="n">work_id_l</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">solrq</span><span class="p">]</span>

        <span class="c1"># generate a list of page ids from the grouped results</span>
        <span class="c1"># NOTE: can&#39;t use alias for group_id because not using aliased queryset</span>
        <span class="c1"># (archive search queryset doesn&#39;t work properly for this query)</span>
        <span class="n">solr_pageq</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">PageSearchQuerySet</span><span class="p">()</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">group_id__in</span><span class="o">=</span><span class="n">work_id_l</span><span class="p">)</span>
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">item_type</span><span class="o">=</span><span class="s2">&quot;page&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
            <span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;group_id&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="s2">&quot;score desc&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">snippets</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;unified&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># get response, this will be cached for rows specified</span>
        <span class="c1"># NOTE: rows argument is needed until this parasolr bug is fixed</span>
        <span class="c1"># https://github.com/Princeton-CDH/parasolr/issues/43</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">solr_pageq</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1"># mimics structure of previous expand/collapse page results</span>
        <span class="c1"># dict is: group_id -&gt; document list with page objects</span>
        <span class="n">page_groups</span> <span class="o">=</span> <span class="p">{</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;groupValue&quot;</span><span class="p">]:</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;doclist&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">groups</span><span class="p">}</span>

        <span class="c1"># get the page highlights from the solr response</span>
        <span class="c1"># dict is: pageid -&gt; pagehighlights</span>
        <span class="n">page_highlights</span> <span class="o">=</span> <span class="n">solr_pageq</span><span class="o">.</span><span class="n">get_highlighting</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">page_groups</span><span class="p">,</span> <span class="n">page_highlights</span><span class="p">)</span></div>


<div class="viewcode-block" id="DigitizedWorkListView.get_context_data">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.DigitizedWorkListView.get_context_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># if the form is not valid, bail out</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;search_form&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span>
            <span class="k">return</span> <span class="n">context</span>

        <span class="n">page_groups</span> <span class="o">=</span> <span class="n">facet_ranges</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @NOTE: Here is the logic that may need to change-&gt;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># catch an error connecting to solr</span>
            <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># get expanded must be called on the *paginated* solr queryset</span>
            <span class="c1"># in order to get the correct number and set of expanded groups</span>
            <span class="c1"># - get everything from the same solr queryset to avoid extra calls</span>
            <span class="n">solrq</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;page_obj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">object_list</span>

            <span class="n">page_groups</span><span class="p">,</span> <span class="n">page_highlights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pages</span><span class="p">(</span><span class="n">solrq</span><span class="p">)</span>

            <span class="n">facet_dict</span> <span class="o">=</span> <span class="n">solrq</span><span class="o">.</span><span class="n">get_facets</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">set_choices_from_facets</span><span class="p">(</span><span class="n">facet_dict</span><span class="o">.</span><span class="n">facet_fields</span><span class="p">)</span>
            <span class="c1"># needs to be inside try/catch or it will re-trigger any error</span>
            <span class="c1"># @NOTE/@TODO: attrdict&#39;s as_dict wasn&#39;t working here? casting now</span>
            <span class="n">facet_ranges</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">facet_dict</span><span class="o">.</span><span class="n">facet_ranges</span><span class="p">)</span>
            <span class="c1"># facet ranges are used for display; when sending to solr we</span>
            <span class="c1"># increase the end bound by one so that year is included;</span>
            <span class="c1"># subtract it back so display matches user entered dates</span>
            <span class="n">facet_ranges</span><span class="p">[</span><span class="s2">&quot;pub_date&quot;</span><span class="p">][</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
            <span class="c1"># override object list with an empty list that can be paginated</span>
            <span class="c1"># so that template display will still work properly</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">object_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solrq</span><span class="o">.</span><span class="n">none</span><span class="p">()</span>
            <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># NOTE: this error should possibly be raised as a 500 error,</span>
            <span class="c1"># or an error status set on the response</span>
            <span class="n">context</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Something went wrong.&quot;</span>

        <span class="nb">set</span><span class="p">(</span><span class="n">page_groups</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="nb">set</span><span class="p">(</span><span class="n">page_highlights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;search_form&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">,</span>
                <span class="c1"># total and object_list provided by paginator</span>
                <span class="s2">&quot;page_groups&quot;</span><span class="p">:</span> <span class="n">page_groups</span><span class="p">,</span>
                <span class="c1"># range facet data for publication date</span>
                <span class="s2">&quot;facet_ranges&quot;</span><span class="p">:</span> <span class="n">facet_ranges</span><span class="p">,</span>
                <span class="s2">&quot;page_highlights&quot;</span><span class="p">:</span> <span class="n">page_highlights</span><span class="p">,</span>
                <span class="c1"># query for use template links to detail view with search</span>
                <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
                <span class="s2">&quot;NO_COLLECTION_LABEL&quot;</span><span class="p">:</span> <span class="n">NO_COLLECTION_LABEL</span><span class="p">,</span>
                <span class="s2">&quot;page_title&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_title</span><span class="p">,</span>
                <span class="s2">&quot;page_description&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_description</span><span class="p">,</span>
                <span class="c1"># dict of source tooltip notes keyed on source label (as that&#39;s what is indexed)</span>
                <span class="s2">&quot;source_notes&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">sn</span><span class="o">.</span><span class="n">get_source_display</span><span class="p">():</span> <span class="n">sn</span><span class="o">.</span><span class="n">note</span> <span class="k">for</span> <span class="n">sn</span> <span class="ow">in</span> <span class="n">SourceNote</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="p">},</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span></div>
</div>



<div class="viewcode-block" id="DigitizedWorkDetailView">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.DigitizedWorkDetailView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DigitizedWorkDetailView</span><span class="p">(</span><span class="n">AjaxTemplateMixin</span><span class="p">,</span> <span class="n">SolrLastModifiedMixin</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display details for a single digitized work. If a work has been</span>
<span class="sd">    surpressed, returns a 410 Gone response.&quot;&quot;&quot;</span>

    <span class="n">ajax_template_name</span> <span class="o">=</span> <span class="s2">&quot;archive/snippets/results_within_list.html&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">DigitizedWork</span>
    <span class="n">slug_field</span> <span class="o">=</span> <span class="s2">&quot;source_id&quot;</span>
    <span class="n">slug_url_kwarg</span> <span class="o">=</span> <span class="s2">&quot;source_id&quot;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">SearchWithinWorkForm</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="c1"># redirect url for a full volume converted to a single excerpt</span>
    <span class="n">redirect_url</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="DigitizedWorkDetailView.get_template_names">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.DigitizedWorkDetailView.get_template_names">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_template_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">SUPPRESSED</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;410.html&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_template_names</span><span class="p">()</span></div>


<div class="viewcode-block" id="DigitizedWorkDetailView.get_solr_lastmodified_filters">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.DigitizedWorkDetailView.get_solr_lastmodified_filters">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_solr_lastmodified_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">index_id</span><span class="p">()}</span>
        <span class="c1"># solr last modified mixin requires a filter; we don&#39;t want to return a header</span>
        <span class="c1"># if we don&#39;t have an object, so return a bogus id</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;NOTFOUND&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="DigitizedWorkDetailView.get_queryset">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.DigitizedWorkDetailView.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># get default queryset and filter by source id</span>
        <span class="n">source_qs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">source_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_id&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">start_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start_page&quot;</span><span class="p">)</span>
        <span class="c1"># if start page is specified, filter to get the correct excerpt</span>
        <span class="k">if</span> <span class="n">start_page</span><span class="p">:</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">source_qs</span><span class="o">.</span><span class="n">by_first_page_orig</span><span class="p">(</span><span class="n">start_page</span><span class="p">)</span>
        <span class="c1"># if start page is NOT specified, ensure we do not retrieve an excerpt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">source_qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pages_orig__exact</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">qs</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="c1">#  if qs is empty and start page is not set, check if there is _one_ excerpt</span>
            <span class="c1"># for the source id; if there is, we want to return a permanent redirect</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">start_page</span> <span class="ow">and</span> <span class="n">source_qs</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">redirect_url</span> <span class="o">=</span> <span class="n">source_qs</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">start_page</span><span class="p">:</span>
                <span class="c1"># if qs empty and start page _is_ set, check for an old id</span>
                <span class="c1"># (previously excerpt ids were based on digital page range)</span>
                <span class="n">digwork_oldid</span> <span class="o">=</span> <span class="n">source_qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">old_workid</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(source_id)s</span><span class="s2">-p</span><span class="si">%(start_page)s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">digwork_oldid</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">redirect_url</span> <span class="o">=</span> <span class="n">digwork_oldid</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">()</span>

        <span class="c1"># otherwise, return a 404</span>
        <span class="k">return</span> <span class="n">qs</span></div>


<div class="viewcode-block" id="DigitizedWorkDetailView.get">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.DigitizedWorkDetailView.get">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle get request, with redirect logic if redirect url is set for</span>
<span class="sd">        a digitized work id converted to a single excerpt.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Http404</span><span class="p">:</span>
            <span class="c1"># if redirect url is set (i.e., tried to retrieve a non-existent</span>
            <span class="c1"># full work, but there is one excerpt with that source id)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">redirect_url</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HttpResponsePermanentRedirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">redirect_url</span><span class="p">)</span>
            <span class="c1"># otherwise, let the 404 propagate</span>
            <span class="k">raise</span>

        <span class="c1"># set status code to 410 gone for suppressed works</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">is_suppressed</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">410</span>

        <span class="k">return</span> <span class="n">response</span></div>


<div class="viewcode-block" id="DigitizedWorkDetailView.get_context_data">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.DigitizedWorkDetailView.get_context_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">digwork</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">]</span>
        <span class="c1"># if suppressed, don&#39;t do any further processing</span>
        <span class="k">if</span> <span class="n">digwork</span><span class="o">.</span><span class="n">is_suppressed</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">context</span>

        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;page_title&quot;</span><span class="p">:</span> <span class="n">digwork</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s2">&quot;page_description&quot;</span><span class="p">:</span> <span class="n">digwork</span><span class="o">.</span><span class="n">public_notes</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># pull in the query if it exists to use</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;query&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">form_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">(</span><span class="n">form_opts</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;search_form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">query</span><span class="p">})</span>

        <span class="c1"># search within a volume only supported for content with full text</span>
        <span class="k">if</span> <span class="n">query</span> <span class="ow">and</span> <span class="n">digwork</span><span class="o">.</span><span class="n">has_fulltext</span><span class="p">:</span>
            <span class="c1"># search on the specified search terms,</span>
            <span class="c1"># filter on digitized work source id and page type,</span>
            <span class="c1"># sort by page order,</span>
            <span class="c1"># only return fields needed for page result display,</span>
            <span class="c1"># configure highlighting on page text content</span>
            <span class="n">solr_pageq</span> <span class="o">=</span> <span class="p">(</span>
                <span class="c1"># NOTE: Addition of an aliased queryset changes the _s keys below</span>
                <span class="n">PageSearchQuerySet</span><span class="p">()</span>
                <span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">query</span><span class="p">)</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">group_id</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">digwork</span><span class="o">.</span><span class="n">index_id</span><span class="p">(),</span> <span class="n">item_type</span><span class="o">=</span><span class="s2">&quot;page&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">highlight</span><span class="p">(</span><span class="s2">&quot;content&quot;</span><span class="p">,</span> <span class="n">snippets</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;unified&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">paginator</span> <span class="o">=</span> <span class="n">GracefulPaginator</span><span class="p">(</span><span class="n">solr_pageq</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">paginate_by</span><span class="p">)</span>
                <span class="n">page_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;page&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">current_page</span> <span class="o">=</span> <span class="n">paginator</span><span class="o">.</span><span class="n">page</span><span class="p">(</span><span class="n">page_num</span><span class="p">)</span>
                <span class="n">paged_result</span> <span class="o">=</span> <span class="n">current_page</span><span class="o">.</span><span class="n">object_list</span>
                <span class="c1"># don&#39;t try to get highlights if there are no results</span>
                <span class="n">highlights</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">paged_result</span><span class="o">.</span><span class="n">get_highlighting</span><span class="p">()</span> <span class="k">if</span> <span class="n">paged_result</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="k">else</span> <span class="p">{}</span>
                <span class="p">)</span>

                <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;search_form&quot;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
                        <span class="s2">&quot;current_results&quot;</span><span class="p">:</span> <span class="n">current_page</span><span class="p">,</span>
                        <span class="c1"># add highlights to context</span>
                        <span class="s2">&quot;page_highlights&quot;</span><span class="p">:</span> <span class="n">highlights</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
                <span class="n">context</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Something went wrong.&quot;</span>
        <span class="k">return</span> <span class="n">context</span></div>
</div>



<div class="viewcode-block" id="DigitizedWorkByRecordId">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.DigitizedWorkByRecordId">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DigitizedWorkByRecordId</span><span class="p">(</span><span class="n">RedirectView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Redirect from DigitizedWork record id to detail view when possible.</span>
<span class="sd">    If there is only one record found, redirect. If multiple are found, 404.&quot;&quot;&quot;</span>

    <span class="n">permanent</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">query_string</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="DigitizedWorkByRecordId.get_redirect_url">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.DigitizedWorkByRecordId.get_redirect_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_redirect_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">work</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">DigitizedWork</span><span class="p">,</span> <span class="n">record_id</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;record_id&quot;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">work</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">MultipleObjectsReturned</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span></div>
</div>



<div class="viewcode-block" id="AddToCollection">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.AddToCollection">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AddToCollection</span><span class="p">(</span><span class="n">PermissionRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    View to bulk add a queryset of :class:`ppa.archive.models.DigitizedWork`</span>
<span class="sd">    to a set of :class:`ppa.archive.models.Collection instances`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">permission_required</span> <span class="o">=</span> <span class="s2">&quot;archive.change_digitizedwork&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">DigitizedWork</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;archive/add_to_collection.html&quot;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">AddToCollectionForm</span>

<div class="viewcode-block" id="AddToCollection.get_context_data">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.AddToCollection.get_context_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Add Digitized Works to Collections&quot;</span>
        <span class="n">context</span><span class="p">[</span><span class="s2">&quot;page_title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Add Digitized Works to Collections&quot;</span>
        <span class="k">return</span> <span class="n">context</span></div>


<div class="viewcode-block" id="AddToCollection.get_success_url">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.AddToCollection.get_success_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Redirect to the :class:`ppa.archive.models.DigitizedWork`</span>
<span class="sd">        change_list in the Django admin with pagination and filters preserved.</span>
<span class="sd">        Expects :meth:`ppa.archive.admin.add_works_to_collection`</span>
<span class="sd">        to have set &#39;collection-add-filters&#39; as a dict in the request&#39;s</span>
<span class="sd">        session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">change_list</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;admin:archive_digitizedwork_changelist&quot;</span><span class="p">)</span>
        <span class="c1"># get request.session&#39;s querystring filter, and if it exists</span>
        <span class="c1"># use it to set the querystring</span>
        <span class="n">querystring</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">filter_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;collection-add-filters&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filter_dict</span><span class="p">:</span>
            <span class="n">querystring</span> <span class="o">=</span> <span class="s2">&quot;?</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">change_list</span><span class="p">,</span> <span class="n">querystring</span><span class="p">)</span></div>


<div class="viewcode-block" id="AddToCollection.get_queryset">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.AddToCollection.get_queryset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a queryset filtered by id, or empty list if no ids&quot;&quot;&quot;</span>
        <span class="c1"># get ids from session if there are any</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;collection-add-ids&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="c1"># if somehow a problematic non-pk is pushed, will be ignored in filter</span>
        <span class="n">digworks</span> <span class="o">=</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">ids</span> <span class="k">if</span> <span class="n">ids</span> <span class="k">else</span> <span class="p">[])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="s2">&quot;id&quot;</span>
        <span class="p">)</span>
        <span class="c1"># revise the stored list in session to eliminate any pks</span>
        <span class="c1"># that don&#39;t exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;collection-add-ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="n">digworks</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">digworks</span></div>


<div class="viewcode-block" id="AddToCollection.post">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.AddToCollection.post">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add :class:`ppa.archive.models.DigitizedWork` instances passed in form</span>
<span class="sd">        data to selected instances of :class:`ppa.archive.models.Collection`,</span>
<span class="sd">        then return to change_list view.</span>

<span class="sd">        Expects a list of DigitizedWork ids to be set in the request session.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">AddToCollectionForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;collection-add-ids&quot;</span><span class="p">]:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span>
            <span class="c1"># get digitzed works from validated form</span>
            <span class="n">digitized_works</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
            <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;collection-add-ids&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;collections&quot;</span><span class="p">]:</span>
                <span class="c1"># add rather than set to ensure add does not replace</span>
                <span class="c1"># previous digitized works in set.</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">digitizedwork_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">digitized_works</span><span class="p">)</span>
            <span class="c1"># reindex solr with the new collection data</span>
            <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">index_items</span><span class="p">(</span><span class="n">digitized_works</span><span class="p">)</span>

            <span class="c1"># create a success message to add to message framework stating</span>
            <span class="c1"># what happened</span>
            <span class="n">num_works</span> <span class="o">=</span> <span class="n">digitized_works</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="n">collections</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">collection</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;collections&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span>
                <span class="n">request</span><span class="p">,</span>
                <span class="s2">&quot;Successfully added </span><span class="si">%d</span><span class="s2"> works to: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_works</span><span class="p">,</span> <span class="n">collections</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="c1"># redirect to the change list with the message intact</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_success_url</span><span class="p">())</span>
        <span class="c1"># make form error more descriptive, default to an error re: pks</span>
        <span class="k">if</span> <span class="s2">&quot;collections&quot;</span> <span class="ow">in</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">form</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="s2">&quot;collections&quot;</span><span class="p">]</span>
            <span class="n">form</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span>
                <span class="s2">&quot;collections&quot;</span><span class="p">,</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Please select at least one Collection&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># Provide an object list for ListView and emulate CBV calling</span>
        <span class="c1"># render_to_response to pass form with errors; just calling super</span>
        <span class="c1"># doesn&#39;t pass the form with error set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="ImportView">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.ImportView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ImportView</span><span class="p">(</span><span class="n">PermissionRequiredMixin</span><span class="p">,</span> <span class="n">FormView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Admin view to import new records from sources that support</span>
<span class="sd">    import (HathiTrust, Gale) by providing a list of ids.&quot;&quot;&quot;</span>

    <span class="n">permission_required</span> <span class="o">=</span> <span class="s2">&quot;archive.add_digitizedwork&quot;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;archive/import.html&quot;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">ImportForm</span>
    <span class="n">page_title</span> <span class="o">=</span> <span class="s2">&quot;Import new records&quot;</span>
    <span class="n">import_mode</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ImportView.get_context_data">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.ImportView.get_context_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Add page title to template context data</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;page_title&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_title</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_title</span><span class="p">,</span>  <span class="c1"># html head title</span>
                <span class="s2">&quot;import_mode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_mode</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span></div>


<div class="viewcode-block" id="ImportView.form_valid">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.ImportView.form_valid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="c1"># Process valid form data; should return an HttpResponse.</span>

        <span class="n">source_ids</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get_source_ids</span><span class="p">()</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span>

        <span class="c1"># set readable import mode for display in template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_mode</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span><span class="p">)[</span><span class="n">source</span><span class="p">]</span>

        <span class="c1"># initialize appropriate importer class according to source</span>
        <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">HATHI</span><span class="p">:</span>
            <span class="n">importer_class</span> <span class="o">=</span> <span class="n">HathiImporter</span>
        <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">GALE</span><span class="p">:</span>
            <span class="n">importer_class</span> <span class="o">=</span> <span class="n">GaleImporter</span>
        <span class="n">importer</span> <span class="o">=</span> <span class="n">importer_class</span><span class="p">(</span><span class="n">source_ids</span><span class="p">)</span>

        <span class="c1"># import the records and report</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_records</span><span class="p">(</span><span class="n">importer</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImportView.import_records">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.ImportView.import_records">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">import_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">importer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Import records based on values submitted in the form&quot;&quot;&quot;</span>
        <span class="n">importer</span><span class="o">.</span><span class="n">filter_existing_ids</span><span class="p">()</span>
        <span class="c1"># add items, and create log entries associated with current user</span>
        <span class="n">importer</span><span class="o">.</span><span class="n">add_items</span><span class="p">(</span><span class="n">log_msg_src</span><span class="o">=</span><span class="s2">&quot;via django admin&quot;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">importer</span><span class="o">.</span><span class="n">index</span><span class="p">()</span>

        <span class="c1"># generate lookup for admin urls keyed on source id to simplify</span>
        <span class="c1"># template logic needed</span>
        <span class="n">admin_urls</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">htid</span><span class="p">:</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;admin:archive_digitizedwork_change&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">pk</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">htid</span><span class="p">,</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">importer</span><span class="o">.</span><span class="n">existing_ids</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">importer</span><span class="o">.</span><span class="n">imported_works</span><span class="p">:</span>
            <span class="n">admin_urls</span><span class="p">[</span><span class="n">work</span><span class="o">.</span><span class="n">source_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span>
                <span class="s2">&quot;admin:archive_digitizedwork_change&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">work</span><span class="o">.</span><span class="n">pk</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># Default form_valid behavior is to redirect to success url,</span>
        <span class="c1"># but we actually want to redisplay the template with results</span>
        <span class="c1"># and allow submitting the form again with a new batch.</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">importer</span><span class="o">.</span><span class="n">output_results</span><span class="p">(),</span>
                <span class="s2">&quot;existing_ids&quot;</span><span class="p">:</span> <span class="n">importer</span><span class="o">.</span><span class="n">existing_ids</span><span class="p">,</span>
                <span class="s2">&quot;form&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">(),</span>  <span class="c1"># new form instance</span>
                <span class="s2">&quot;page_title&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_title</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_title</span><span class="p">,</span>
                <span class="s2">&quot;admin_urls&quot;</span><span class="p">:</span> <span class="n">admin_urls</span><span class="p">,</span>
                <span class="s2">&quot;import_mode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">import_mode</span><span class="p">,</span>  <span class="c1"># readable version of hathi/gale</span>
            <span class="p">},</span>
        <span class="p">)</span></div>
</div>



<div class="viewcode-block" id="OpenSearchDescriptionView">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.views.OpenSearchDescriptionView">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OpenSearchDescriptionView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Basic open search description for searching the archive</span>
<span class="sd">    via browser or other tools.&quot;&quot;&quot;</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;archive/opensearch_description.xml&quot;</span>
    <span class="n">content_type</span> <span class="o">=</span> <span class="s2">&quot;application/opensearchdescription+xml&quot;</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/ppa_logo.png" alt="Logo" />
    
    <h1 class="logo logo-name">Princeton Prosody Archive</h1>
    
  </a>
</p>



<p class="blurb">Django web application for "Princeton Prosody Archive" CDH project</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Princeton-CDH&repo=ppa-django&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../codedocs.html">Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deploynotes.html">Deploy Notes</a></li>
</ul>


<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><div class="powered_by">
<p>Powered by:</p>
<a href="http://cdh.princeton.edu/">
<img src="https://cdh.princeton.edu/static/img/CDH_logo.svg"
    alt="Center for Digital Humanities @ Princeton" />
</a>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, CDH @ Princeton University.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>