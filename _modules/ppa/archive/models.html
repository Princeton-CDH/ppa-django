<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ppa.archive.models &#8212; Princeton Prosody Archive 3.15.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=27fed22d" />
    <script src="../../../_static/documentation_options.js?v=31597fc9"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for ppa.archive.models</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">zipfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">ZipFile</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">cached_property</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.admin.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ADDITION</span><span class="p">,</span> <span class="n">CHANGE</span><span class="p">,</span> <span class="n">LogEntry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.contenttypes.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContentType</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flags</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flags</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">intspan</span><span class="w"> </span><span class="kn">import</span> <span class="n">ParseError</span> <span class="k">as</span> <span class="n">IntSpanParseError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">intspan</span><span class="w"> </span><span class="kn">import</span> <span class="n">intspan</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pairtree</span><span class="w"> </span><span class="kn">import</span> <span class="n">storage_exceptions</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">parasolr.django</span><span class="w"> </span><span class="kn">import</span> <span class="n">SolrQuerySet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">parasolr.django.indexing</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelIndexable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">parasolr.indexing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Indexable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wagtail.admin.panels</span><span class="w"> </span><span class="kn">import</span> <span class="n">FieldPanel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wagtail.fields</span><span class="w"> </span><span class="kn">import</span> <span class="n">RichTextField</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">wagtail.snippets.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">register_snippet</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ppa.archive</span><span class="w"> </span><span class="kn">import</span> <span class="n">eebo_tcp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ppa.archive.gale</span><span class="w"> </span><span class="kn">import</span> <span class="n">GaleAPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ppa.archive.hathi</span><span class="w"> </span><span class="kn">import</span> <span class="n">HathiBibliographicAPI</span><span class="p">,</span> <span class="n">HathiObject</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1">#: label to use for items that are not in a collection</span>
<span class="n">NO_COLLECTION_LABEL</span> <span class="o">=</span> <span class="s2">&quot;Uncategorized&quot;</span>


<div class="viewcode-block" id="TrackChangesModel">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.TrackChangesModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TrackChangesModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;:class:`~django.models.Model` mixin that keeps a copy of initial</span>
<span class="sd">    data in order to check if fields have been changed. Change detection</span>
<span class="sd">    only works on the current instance of an object.&quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># store a copy of model data to allow for checking if</span>
        <span class="c1"># it has changed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<div class="viewcode-block" id="TrackChangesModel.save">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.TrackChangesModel.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Saves data and reset copy of initial data.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># update copy of initial data to reflect saved state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__initial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>


<div class="viewcode-block" id="TrackChangesModel.has_changed">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.TrackChangesModel.has_changed">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;check if a field has been changed&quot;&quot;&quot;</span>
        <span class="c1"># Only consider the field changed if the object has been saved</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__initial</span><span class="p">[</span><span class="n">field</span><span class="p">]</span></div>


<div class="viewcode-block" id="TrackChangesModel.initial_value">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.TrackChangesModel.initial_value">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initial_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return the initial value for a field&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__initial</span><span class="p">[</span><span class="n">field</span><span class="p">]</span></div>
</div>



<div class="viewcode-block" id="Collection">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.Collection">[docs]</a>
<span class="nd">@register_snippet</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Collection</span><span class="p">(</span><span class="n">TrackChangesModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A collection of :class:`ppa.archive.models.DigitizedWork` instances.&quot;&quot;&quot;</span>

    <span class="c1">#: the name of the collection</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="c1">#: a RichText description of the collection</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">RichTextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: flag to indicate collections to be excluded by default in</span>
    <span class="c1">#: public search</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Exclude by default on public search.&quot;</span>
    <span class="p">)</span>

    <span class="c1"># configure for editing in wagtail admin</span>
    <span class="n">panels</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">FieldPanel</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
        <span class="n">FieldPanel</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;check if name has been changed (only works on current instance)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Collection.stats">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.Collection.stats">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stats</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collection counts and date ranges, based on what is in Solr.</span>
<span class="sd">        Returns a dictionary where they keys are collection names and</span>
<span class="sd">        values are a dictionary with count and dates.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># NOTE: if we *only* want counts, could just do a regular facet</span>
        <span class="n">sqs</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">SolrQuerySet</span><span class="p">()</span>
            <span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="s2">&quot;{!tag=piv1 min=true max=true}pub_date&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">facet</span><span class="p">(</span><span class="n">pivot</span><span class="o">=</span><span class="s2">&quot;{!stats=piv1}collections_exact&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">facet_pivot</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">get_facets</span><span class="p">()</span><span class="o">.</span><span class="n">facet_pivot</span>
        <span class="c1"># simplify the pivot stat data for display</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">facet_pivot</span><span class="o">.</span><span class="n">collections_exact</span><span class="p">:</span>
            <span class="n">pub_date_stats</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">stats_fields</span><span class="o">.</span><span class="n">pub_date</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">collection</span><span class="o">.</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">collection</span><span class="o">.</span><span class="n">count</span><span class="p">,</span>
                <span class="s2">&quot;dates&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%(min)d</span><span class="s2">â€“</span><span class="si">%(max)d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pub_date_stats</span>
                <span class="k">if</span> <span class="n">pub_date_stats</span><span class="o">.</span><span class="n">max</span> <span class="o">!=</span> <span class="n">pub_date_stats</span><span class="o">.</span><span class="n">min</span>
                <span class="k">else</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pub_date_stats</span><span class="o">.</span><span class="n">min</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,),</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">stats</span></div>
</div>



<div class="viewcode-block" id="Cluster">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.Cluster">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Cluster</span><span class="p">(</span><span class="n">TrackChangesModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A model to collect groups of works such as reprints or editions that should</span>
<span class="sd">    be collapsed in the main archive search and accessible together.&quot;&quot;&quot;</span>

    <span class="n">cluster_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="s2">&quot;Cluster ID&quot;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Unique identifier for a cluster of digitized works&quot;</span><span class="p">,</span>
        <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">,)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_id</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;cluster </span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>



<div class="viewcode-block" id="ProtectedWorkFieldFlags">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.ProtectedWorkFieldFlags">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ProtectedWorkFieldFlags</span><span class="p">(</span><span class="n">Flags</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;:class:`flags.Flags` instance to indicate which :class:`DigitizedWork`</span>
<span class="sd">    fields should be protected if edited in the admin.&quot;&quot;&quot;</span>

    <span class="c1">#: title</span>
    <span class="n">title</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1">#: subtitle</span>
    <span class="n">subtitle</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1">#: sort title</span>
    <span class="n">sort_title</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1">#: enumcron</span>
    <span class="n">enumcron</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1">#: author</span>
    <span class="n">author</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1">#: place of publication</span>
    <span class="n">pub_place</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1">#: publisher</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="p">()</span>
    <span class="c1">#: publication date</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="p">()</span>

<div class="viewcode-block" id="ProtectedWorkFieldFlags.deconstruct">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.ProtectedWorkFieldFlags.deconstruct">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">deconstruct</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Give Django information needed to make</span>
<span class="sd">        :class:`ProtectedWorkFieldFlags.no_flags` default in migration.&quot;&quot;&quot;</span>
        <span class="c1"># (import path, [args], kwargs)</span>
        <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;ppa.archive.models.ProtectedWorkFieldFlags&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;no_flags&quot;</span><span class="p">],</span> <span class="p">{})</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_simple_str</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)))</span></div>



<div class="viewcode-block" id="ProtectedWorkField">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.ProtectedWorkField">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ProtectedWorkField</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;PositiveSmallIntegerField subclass that returns a</span>
<span class="sd">    :class:`ProtectedWorkFieldFlags` object and stores as integer.&quot;&quot;&quot;</span>

    <span class="n">description</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;A field that stores an instance of :class:`ProtectedWorkFieldFlags` &quot;</span>
        <span class="s2">&quot;as an integer.&quot;</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make the field unnullable; by default, not allowed to be blank.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;blank&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;blank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">verbose_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="ProtectedWorkField.from_db_value">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.ProtectedWorkField.from_db_value">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_db_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Always return an instance of :class:`ProtectedWorkFieldFlags`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ProtectedWorkFieldFlags</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProtectedWorkField.get_internal_type">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.ProtectedWorkField.get_internal_type">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_internal_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Preserve type as PositiveSmallIntegerField&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;PositiveSmallIntegerField&quot;</span></div>


<div class="viewcode-block" id="ProtectedWorkField.get_prep_value">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.ProtectedWorkField.get_prep_value">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_prep_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="ProtectedWorkField.to_python">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.ProtectedWorkField.to_python">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Always return an instance of :class:`ProtectedWorkFieldFlags`&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ProtectedWorkFieldFlags</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SignalHandlers">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.SignalHandlers">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SignalHandlers</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Signal handlers for indexing :class:`DigitizedWork` records when</span>
<span class="sd">    :class:`Collection` or :class:`Cluster` records are saved or deleted.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SignalHandlers.collection_save">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.SignalHandlers.collection_save">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">collection_save</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;signal handler for collection save; reindex associated digitized works&quot;&quot;&quot;</span>
        <span class="c1"># only reindex if collection name has changed</span>
        <span class="c1"># and if collection has already been saved</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">pk</span> <span class="ow">and</span> <span class="n">instance</span><span class="o">.</span><span class="n">name_changed</span><span class="p">:</span>
            <span class="c1"># if the collection has any works associated</span>
            <span class="n">works</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">digitizedwork_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">works</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;collection save, reindexing </span><span class="si">{</span><span class="n">works</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2"> related works&quot;</span>
                <span class="p">)</span>
                <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">index_items</span><span class="p">(</span><span class="n">works</span><span class="p">)</span></div>


<div class="viewcode-block" id="SignalHandlers.collection_delete">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.SignalHandlers.collection_delete">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">collection_delete</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;signal handler for collection delete; clear associated digitized</span>
<span class="sd">        works and reindex&quot;&quot;&quot;</span>
        <span class="c1"># get a list of ids for collected works before clearing them</span>
        <span class="n">digwork_ids</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">digitizedwork_set</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># find the items based on the list of ids to reindex</span>
        <span class="n">digworks</span> <span class="o">=</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">digwork_ids</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;collection delete, reindexing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">digworks</span><span class="p">)</span><span class="si">}</span><span class="s2"> works&quot;</span><span class="p">)</span>

        <span class="c1"># NOTE: this sends pre/post clear signal, but it&#39;s not obvious</span>
        <span class="c1"># how to take advantage of that</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">digitizedwork_set</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">index_items</span><span class="p">(</span><span class="n">digworks</span><span class="p">)</span></div>


<div class="viewcode-block" id="SignalHandlers.cluster_save">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.SignalHandlers.cluster_save">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cluster_save</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;signal handler for cluster save; reindex pages for</span>
<span class="sd">        associated digitized works&quot;&quot;&quot;</span>
        <span class="c1"># only reindex if cluster id has changed</span>
        <span class="c1"># and if object has already been saved to the db</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">pk</span> <span class="ow">and</span> <span class="n">instance</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">):</span>
            <span class="c1"># if the cluster has any works associated</span>
            <span class="n">works</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">digitizedwork_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">works</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="c1"># get a total of page count for affected works</span>
                <span class="n">page_count</span> <span class="o">=</span> <span class="n">works</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                    <span class="n">page_count</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Sum</span><span class="p">(</span><span class="s2">&quot;page_count&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;cluster id has changed, reindexing </span><span class="si">%d</span><span class="s2"> works and </span><span class="si">%d</span><span class="s2"> pages&quot;</span><span class="p">,</span>
                    <span class="n">works</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
                    <span class="n">page_count</span><span class="p">[</span><span class="s2">&quot;page_count&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">index_items</span><span class="p">(</span><span class="n">works</span><span class="p">)</span>
                <span class="c1"># reindex pages (this may be slow...)</span>
                <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">works</span><span class="p">:</span>
                    <span class="n">work</span><span class="o">.</span><span class="n">index_items</span><span class="p">(</span><span class="n">Page</span><span class="o">.</span><span class="n">page_index_data</span><span class="p">(</span><span class="n">work</span><span class="p">))</span></div>


<div class="viewcode-block" id="SignalHandlers.cluster_delete">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.SignalHandlers.cluster_delete">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cluster_delete</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;signal handler for cluster delete; clear associated digitized</span>
<span class="sd">        works and reindex&quot;&quot;&quot;</span>
        <span class="c1"># get a list of ids for collected works before clearing them</span>
        <span class="n">digwork_ids</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">digitizedwork_set</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># find the items based on the list of ids to reindex</span>
        <span class="n">digworks</span> <span class="o">=</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">digwork_ids</span><span class="p">))</span>
        <span class="c1"># get a total of page count for affected works</span>
        <span class="n">page_count</span> <span class="o">=</span> <span class="n">digworks</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">page_count</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Sum</span><span class="p">(</span><span class="s2">&quot;page_count&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;cluster delete, reindexing </span><span class="si">%d</span><span class="s2"> works and </span><span class="si">%d</span><span class="s2"> pages&quot;</span><span class="p">,</span>
            <span class="n">digworks</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="n">page_count</span><span class="p">[</span><span class="s2">&quot;page_count&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># NOTE: this sends pre/post clear signal, but it&#39;s not obvious</span>
        <span class="c1"># how to take advantage of that for reindexing</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">digitizedwork_set</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">index_items</span><span class="p">(</span><span class="n">digworks</span><span class="p">)</span>
        <span class="c1"># reindex pages (this may be slow...)</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">digworks</span><span class="p">:</span>
            <span class="n">work</span><span class="o">.</span><span class="n">index_items</span><span class="p">(</span><span class="n">Page</span><span class="o">.</span><span class="n">page_index_data</span><span class="p">(</span><span class="n">work</span><span class="p">))</span></div>


<div class="viewcode-block" id="SignalHandlers.handle_digwork_cluster_change">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.SignalHandlers.handle_digwork_cluster_change">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_digwork_cluster_change</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;when a :class:`DigitizedWork` is saved,</span>
<span class="sd">        reindex pages if cluster id has changed&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">DigitizedWork</span><span class="p">)</span> <span class="ow">and</span> <span class="n">instance</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Cluster changed for </span><span class="si">%s</span><span class="s2">; indexing </span><span class="si">%d</span><span class="s2"> pages&quot;</span><span class="p">,</span>
                <span class="n">instance</span><span class="p">,</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">page_count</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">index_items</span><span class="p">(</span><span class="n">Page</span><span class="o">.</span><span class="n">page_index_data</span><span class="p">(</span><span class="n">instance</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="validate_page_range">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.validate_page_range">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_page_range</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure page range can be parsed as an integer span&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">intspan</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">IntSpanParseError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
            <span class="s2">&quot;Parse error: </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">err</span><span class="p">},</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="DigitizedWorkQuerySet">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWorkQuerySet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DigitizedWorkQuerySet</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">QuerySet</span><span class="p">):</span>
<div class="viewcode-block" id="DigitizedWorkQuerySet.by_first_page_orig">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWorkQuerySet.by_first_page_orig">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">by_first_page_orig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_page</span><span class="p">):</span>
        <span class="s2">&quot;find records based on first page in original page range&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pages_orig__regex</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="n">start_page</span><span class="si">}</span><span class="s2">([,-]|:|</span><span class="se">\b</span><span class="s2">|$)&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DigitizedWork">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DigitizedWork</span><span class="p">(</span><span class="n">ModelIndexable</span><span class="p">,</span> <span class="n">TrackChangesModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Record to manage digitized works included in PPA and store their basic</span>
<span class="sd">    metadata.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">HATHI</span> <span class="o">=</span> <span class="s2">&quot;HT&quot;</span>
    <span class="n">GALE</span> <span class="o">=</span> <span class="s2">&quot;G&quot;</span>
    <span class="n">EEBO</span> <span class="o">=</span> <span class="s2">&quot;E&quot;</span>
    <span class="n">OTHER</span> <span class="o">=</span> <span class="s2">&quot;O&quot;</span>
    <span class="n">SOURCE_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">HATHI</span><span class="p">,</span> <span class="s2">&quot;HathiTrust&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">GALE</span><span class="p">,</span> <span class="s2">&quot;Gale&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">EEBO</span><span class="p">,</span> <span class="s2">&quot;EEBO-TCP&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">OTHER</span><span class="p">,</span> <span class="s2">&quot;Other&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1">#: source of the record, HathiTrust or elsewhere</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">SOURCE_CHOICES</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">HATHI</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Source of the record.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1">#: source identifier; hathi id for HathiTrust materials</span>
    <span class="n">source_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Source ID&quot;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Source identifier. Must be unique when combined with page range; &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;used for site URL. (HT id for HathiTrust materials.)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1">#: source url where the original can be accessed</span>
    <span class="n">source_url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;Source URL&quot;</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;URL where the source item can be accessed&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1">#: record id; for Hathi materials, used for different copies of</span>
    <span class="c1">#: the same work or for different editions/volumes of a work</span>
    <span class="n">record_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;For HathiTrust materials, record id (use to aggregate &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;copies or volumes); for Gale materials, ESTC id.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1">#: title of the work; using TextField to allow for long titles</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Main title&quot;</span><span class="p">)</span>
    <span class="c1">#: subtitle of the work; using TextField to allow for long titles</span>
    <span class="n">subtitle</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Subtitle, if any (optional)&quot;</span>
    <span class="p">)</span>
    <span class="c1">#: sort title: title without leading non-sort characters, from marc</span>
    <span class="n">sort_title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Sort title from MARC record or title without leading article&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1">#: enumeration/chronology (hathi-specific; contains volume or version)</span>
    <span class="n">enumcron</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="s2">&quot;Enumeration/Chronology/Volume&quot;</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Enumcron for HathiTrust material; volume for Gale material&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># NOTE: may eventually to convert to foreign key</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Authorized name of the author, last name first.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1">#: place of publication</span>
    <span class="n">pub_place</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="s2">&quot;Place of Publication&quot;</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: publisher</span>
    <span class="n">publisher</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># Needs to be integer to allow aggregating max/min, filtering by date</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="s2">&quot;Publication Date&quot;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: number of pages in the work (or page range, for an excerpt)</span>
    <span class="n">page_count</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Automatically calculated on import; &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;recalculated on save when digital page range changes&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1">#: public notes field for this work</span>
    <span class="n">public_notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Notes on edition or other details (displayed on public site)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1">#: internal team notes, not displayed on the public facing site</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Internal curation notes (not displayed on public site)&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1">#: :class:`ProtectedWorkField` instance to indicate metadata fields</span>
    <span class="c1">#: that should be preserved from bulk updates because they have been</span>
    <span class="c1">#: modified in Django admin.</span>
    <span class="n">protected_fields</span> <span class="o">=</span> <span class="n">ProtectedWorkField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="n">ProtectedWorkFieldFlags</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># required for save as new, where we make editable to copy</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Fields protected from HathiTrust bulk &quot;</span>
        <span class="s2">&quot;update because they have been manually edited in the &quot;</span>
        <span class="s2">&quot;Django admin.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1">#: collections that this work is part of</span>
    <span class="n">collections</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Collection</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#: optional cluster for aggregating works</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">Cluster</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span>
    <span class="p">)</span>

    <span class="c1">#: date added to the archive</span>
    <span class="n">added</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#: date of last modification of the local record</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">PUBLIC</span> <span class="o">=</span> <span class="s2">&quot;P&quot;</span>
    <span class="n">SUPPRESSED</span> <span class="o">=</span> <span class="s2">&quot;S&quot;</span>
    <span class="n">STATUS_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">PUBLIC</span><span class="p">,</span> <span class="s2">&quot;Public&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">SUPPRESSED</span><span class="p">,</span> <span class="s2">&quot;Suppressed&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1">#: status of record; currently choices are public or suppressed</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">STATUS_CHOICES</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">PUBLIC</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Changing status to suppressed will remove rsync data &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;for that volume and remove from the public index. This is &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;currently not reversible; use with caution.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">FULL</span> <span class="o">=</span> <span class="s2">&quot;F&quot;</span>
    <span class="n">EXCERPT</span> <span class="o">=</span> <span class="s2">&quot;E&quot;</span>
    <span class="n">ARTICLE</span> <span class="o">=</span> <span class="s2">&quot;A&quot;</span>
    <span class="n">ITEMTYPE_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">FULL</span><span class="p">,</span> <span class="s2">&quot;Full work&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">EXCERPT</span><span class="p">,</span> <span class="s2">&quot;Excerpt&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="n">ARTICLE</span><span class="p">,</span> <span class="s2">&quot;Article&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1">#: type of record, whether excerpt, article, or full; defaults to full</span>
    <span class="n">item_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">ITEMTYPE_CHOICES</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">FULL</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Portion of the work that is included; &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;used to determine icon for public display.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1">#: book or journal title for excerpt or article</span>
    <span class="n">book_journal</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="s2">&quot;Book/Journal title&quot;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;title of the book or journal that includes &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;this content (excerpt/article only)&quot;</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">pages_orig</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="s2">&quot;Page range (original)&quot;</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Page range in the original work (for display and citation).&quot;</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">pages_digital</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="s2">&quot;Page range (digital edition)&quot;</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Sequence of pages in the digital edition. &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;Use full digits for start and end separated by a dash (##-##); &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;for multiple sequences, separate ranges by a comma (##-##, ##-##). &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;NOTE: removing page range may have unexpected results.&quot;</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validate_page_range</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">old_workid</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="s2">&quot;Old Work ID&quot;</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;past work id; used for excerpts previously &quot;</span>
        <span class="o">+</span> <span class="s2">&quot;identified by start of digital page range&quot;</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># use custom queryset</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">DigitizedWorkQuerySet</span><span class="o">.</span><span class="n">as_manager</span><span class="p">()</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;sort_title&quot;</span><span class="p">,)</span>
        <span class="c1"># require unique combination of source id + page range,</span>
        <span class="c1"># since we need to allow multiple excerpts from the same source</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">models</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span>
                <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;source_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pages_digital&quot;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;unique_sourceid_pagerange&quot;</span>
            <span class="p">),</span>
            <span class="c1"># we are now using original page range for unique id,</span>
            <span class="c1"># so require source id + pages_orig to be unique</span>
            <span class="n">models</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span>
                <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;source_id&quot;</span><span class="p">,</span> <span class="s2">&quot;pages_orig&quot;</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;unique_sourceid_pages_orig&quot;</span>
            <span class="p">),</span>
        <span class="p">]</span>

<div class="viewcode-block" id="DigitizedWork.get_absolute_url">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.get_absolute_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return object&#39;s url for</span>
<span class="sd">        :class:`ppa.archive.views.DigitizedWorkDetailView`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url_opts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;source_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">}</span>
        <span class="c1"># start page must be specified if set but must not be included if empty</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages_orig</span><span class="p">:</span>
            <span class="n">url_opts</span><span class="p">[</span><span class="s2">&quot;start_page&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_page</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;archive:detail&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">url_opts</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default string display. Uses :attr:`source_id`</span>
<span class="sd">        and :attr:`pages_orig` if any&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages_orig</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages_orig</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">index_cluster_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function to get a string representation of the cluster</span>
<span class="sd">        (or self if no cluster). Reduces redunadancy elsewhere.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_id</span><span class="p">()</span>

<div class="viewcode-block" id="DigitizedWork.clean_fields">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.clean_fields">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exclude</span> <span class="ow">or</span> <span class="s2">&quot;pages_digital&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
            <span class="c1"># normalize whitespace before applying regex validation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pages_digital</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages_digital</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean_fields</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_suppressed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Item has been suppressed (based on :attr:`status`).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPRESSED</span>

<div class="viewcode-block" id="DigitizedWork.display_title">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.display_title">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">display_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;admin display title to allow displaying title but sorting on sort_title&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span></div>


    <span class="n">display_title</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;title&quot;</span>
    <span class="n">display_title</span><span class="o">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s2">&quot;sort_title&quot;</span>

<div class="viewcode-block" id="DigitizedWork.is_public">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.is_public">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_public</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;admin display field indicating if record is public or suppressed&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">PUBLIC</span></div>


    <span class="n">is_public</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&quot;Public&quot;</span>
    <span class="n">is_public</span><span class="o">.</span><span class="n">boolean</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">is_public</span><span class="o">.</span><span class="n">admin_order_field</span> <span class="o">=</span> <span class="s2">&quot;status&quot;</span>

    <span class="c1">#: regular expresion for cleaning preliminary text from publisher names</span>
    <span class="n">printed_by_re</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;^(Printed)?( and )?(Pub(.|lished|lisht)?)?( and sold)? (by|for|at)( the)? ?&quot;</span>
    <span class="p">)</span>
    <span class="c1"># Printed by/for (the); Printed and sold by; Printed and published by;</span>
    <span class="c1"># Pub./Published/Publisht at/by/for the</span>
    <span class="n">pubyear_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?P&lt;year&gt;\d</span><span class="si">{4}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_fulltext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if an item has full text (i.e., items from</span>
<span class="sd">        HathiTrust, Gale, or EEBO-TCP).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">HATHI</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">GALE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EEBO</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">work_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Work type formatted for COinS metadata (matches Solr field format).&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_item_type_display</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hathi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;:class:`ppa.archive.hathi.HathiObject` for HathiTrust records,</span>
<span class="sd">        for working with data in HathiTrust pairtree data structure.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">HATHI</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HathiObject</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="DigitizedWork.save">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># if status has changed so that object is now suppressed,</span>
        <span class="c1"># do some cleanup</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">SUPPRESSED</span><span class="p">:</span>
            <span class="c1"># remove indexed page content from Solr using index id</span>
            <span class="c1"># (i.e., if excerpt, should only remove content for this excerpt,</span>
            <span class="c1"># not all excerpts in this volume)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solr</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">delete_by_query</span><span class="p">(</span><span class="s1">&#39;group_id_s:&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_id</span><span class="p">())</span>
            <span class="c1"># if this is a HathiTrust item, remove pairtree data</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">HATHI</span><span class="p">:</span>
                <span class="c1"># if this is a full work (not excerpted), remove</span>
                <span class="c1"># if this is an excerpt, should only remove if there are no other</span>
                <span class="c1"># public excerpts from this volume</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">item_type</span> <span class="o">==</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">FULL</span>
                    <span class="ow">or</span> <span class="ow">not</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                        <span class="n">status</span><span class="o">=</span><span class="n">DigitizedWork</span><span class="o">.</span><span class="n">PUBLIC</span><span class="p">,</span> <span class="n">source_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_id</span>
                    <span class="p">)</span>
                    <span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">exists</span><span class="p">()</span>
                <span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">hathi</span><span class="o">.</span><span class="n">delete_pairtree_data</span><span class="p">()</span>

        <span class="c1"># Solr identifier is based on combination of source id and first page;</span>
        <span class="c1"># if either changes, remove the old record from Solr before saving</span>
        <span class="c1"># with the new identifier</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s2">&quot;source_id&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s2">&quot;pages_digital&quot;</span><span class="p">):</span>
            <span class="c1"># store the updated values</span>
            <span class="n">new_source_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span>
            <span class="n">new_pages_digital</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages_digital</span>
            <span class="c1"># temporarily revert to previous value to remove from index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_value</span><span class="p">(</span><span class="s2">&quot;source_id&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pages_digital</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">initial_value</span><span class="p">(</span><span class="s2">&quot;pages_digital&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_from_index</span><span class="p">()</span>
            <span class="c1"># restore new values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span> <span class="o">=</span> <span class="n">new_source_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pages_digital</span> <span class="o">=</span> <span class="n">new_pages_digital</span>

        <span class="c1"># if excerpt page range has changed</span>
        <span class="c1"># OR this is a new record with a page range</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s2">&quot;pages_digital&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pk</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages_digital</span>
        <span class="p">):</span>
            <span class="c1"># update the page count if possible (i.e., not a Gale record)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">page_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_pages</span><span class="p">()</span>
            <span class="c1"># if page range changed on existing record, clear out old index</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages_digital</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># update index to remove all pages that are no longer in range</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solr</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">delete_by_query</span><span class="p">(</span>
                    <span class="s1">&#39;source_id:&quot;</span><span class="si">%s</span><span class="s1">&quot; AND item_type:page NOT order:(</span><span class="si">%s</span><span class="s1">)&#39;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span> <span class="s2">&quot; OR &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_span</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="c1"># any page range change requires reindexing (potentially slow)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Indexing pages for new excerpt </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reindexing pages for </span><span class="si">%s</span><span class="s2"> after change to page range&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_items</span><span class="p">(</span><span class="n">Page</span><span class="o">.</span><span class="n">page_index_data</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="c1"># NOTE: removing a page range may not work as expected</span>
            <span class="c1"># (does not recalculate page count; cannot recalculate for Gale items)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="DigitizedWork.clean">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.clean">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add custom validation to trigger a save error in the admin</span>
<span class="sd">        if someone tries to unsuppress a record that has been suppressed</span>
<span class="sd">        (not yet supported).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPRESSED</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Unsuppressing records not yet supported.&quot;</span><span class="p">)</span>

        <span class="c1"># should not be editable in admin, but add a validation check</span>
        <span class="c1"># just in case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_changed</span><span class="p">(</span><span class="s2">&quot;source_id&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">HATHI</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">EEBO</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Changing source ID for HathiTrust or EEBO-TCP record is not supported&quot;</span>
            <span class="p">)</span>

        <span class="c1"># if original page range is set, check that first page is unique</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages_orig</span><span class="p">:</span>
            <span class="n">first_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_page_original</span>
            <span class="c1"># check for other excerpts in this work with the same first page</span>
            <span class="n">other_excerpts</span> <span class="o">=</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">source_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source_id</span>
            <span class="p">)</span><span class="o">.</span><span class="n">by_first_page_orig</span><span class="p">(</span><span class="n">first_page</span><span class="p">)</span>
            <span class="c1"># if this record has already been saved, exclude it when checking</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                <span class="n">other_excerpts</span> <span class="o">=</span> <span class="n">other_excerpts</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">other_excerpts</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;pages_orig&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;First page </span><span class="si">{</span><span class="n">first_page</span><span class="si">}</span><span class="s2"> is not unique for this source&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span></div>


<div class="viewcode-block" id="DigitizedWork.compare_protected_fields">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.compare_protected_fields">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compare_protected_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compare protected fields in a</span>
<span class="sd">        :class:`ppa.archive.models.DigitizedWork` instance and return those</span>
<span class="sd">        that are changed.</span>

<span class="sd">        :param object db_obj: Database instance of a</span>
<span class="sd">            :class:`~ppa.archive.models.DigitizedWork`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">changed_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># if a field has changed, append to changed fields</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ProtectedWorkFieldFlags</span><span class="o">.</span><span class="n">all_flags</span><span class="p">:</span>
            <span class="c1"># field is in format of ProtectedWorkFieldFlags.title</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="c1"># if obj has a different value for a protected field</span>
            <span class="c1"># than its db counterpart</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">db_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
                <span class="c1"># append as a now protected field</span>
                <span class="n">changed_fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">changed_fields</span></div>


<div class="viewcode-block" id="DigitizedWork.populate_fields">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.populate_fields">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">populate_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Conditionally update fields as protected by flags using Hathi</span>
<span class="sd">        bibdata information.</span>

<span class="sd">        :param dict field_data: A dictionary of fields updated from a</span>
<span class="sd">            :class:`ppa.archive.hathi.HathiBibliographicRecord` instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">protected_fields</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protected_fields</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">field_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">protected_fields</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="DigitizedWork.metadata_from_marc">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.metadata_from_marc">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">metadata_from_marc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">marc_record</span><span class="p">,</span> <span class="n">populate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get metadata from MARC record and return a dictionary</span>
<span class="sd">        of the data. When populate is True, calls `populate_fields`</span>
<span class="sd">        to set values.&quot;&quot;&quot;</span>

        <span class="c1"># create dictionary to store bibliographic information</span>
        <span class="n">field_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># set title and subtitle from marc if possible</span>
        <span class="c1"># - clean title: strip trailing space &amp; slash and initial bracket</span>
        <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">marc_record</span><span class="p">[</span><span class="s2">&quot;245&quot;</span><span class="p">][</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; /&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>

        <span class="c1"># according to PUL CAMS,</span>
        <span class="c1"># 245 subfield contains the subtitle *if* the preceding field</span>
        <span class="c1"># ends with a colon. (Otherwise could be a parallel title,</span>
        <span class="c1"># e.g. title in another language).</span>
        <span class="c1"># HOWEVER: metadata from Hathi doesn&#39;t seem to follow this</span>
        <span class="c1"># pattern (possibly due to records being older?)</span>

        <span class="c1"># subfields is a list of code, value, code, value</span>
        <span class="c1"># iterate in paired steps of two starting with first and second</span>
        <span class="c1"># for code, value in zip(marc_record[&#39;245&#39;].subfields[0::2],</span>
        <span class="c1">#                        marc_record[&#39;245&#39;].subfields[1::2]):</span>
        <span class="c1">#     if code == &#39;b&#39;:</span>
        <span class="c1">#         break</span>
        <span class="c1">#     preceding_character = value[-1:]</span>

        <span class="c1"># if preceding_character == &#39;:&#39;:</span>
        <span class="c1">#     self.subtitle = marc_record[&#39;245&#39;][&#39;b&#39;] or &#39;&#39;</span>
        <span class="c1"># NOTE: skipping preceding character check for now</span>
        <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;subtitle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">marc_record</span><span class="p">[</span><span class="s2">&quot;245&quot;</span><span class="p">][</span><span class="s2">&quot;b&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># strip trailing space &amp; slash from subtitle</span>
        <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;subtitle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;subtitle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot; /&quot;</span><span class="p">)</span>
        <span class="c1"># indicator 2 provides the number of characters to be</span>
        <span class="c1"># skipped when sorting (could be 0)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">non_sort</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">marc_record</span><span class="p">[</span><span class="s2">&quot;245&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># at least one record has a space here instead of a number</span>
            <span class="c1"># probably a data error, but handle it</span>
            <span class="c1"># - assuming no non-sort characters</span>
            <span class="n">non_sort</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># strip whitespace, since a small number of records have a</span>
        <span class="c1"># nonsort value that doesn&#39;t include a space after a</span>
        <span class="c1"># definite article.</span>
        <span class="c1"># Also strip punctuation, since MARC only includes it in</span>
        <span class="c1"># non-sort count when there is a definite article.</span>
        <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;sort_title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">marc_record</span><span class="o">.</span><span class="n">title</span><span class="p">()[</span><span class="n">non_sort</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &quot;[&#39;</span><span class="p">)</span>
        <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">marc_record</span><span class="o">.</span><span class="n">author</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># remove a note present on some records and strip whitespace</span>
        <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[from old catalog]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># removing trailing period, except when it is part of an</span>
        <span class="c1"># initial or known abbreviation (i.e, Esq.)</span>
        <span class="c1"># Look for single initial, but support initials with no spaces</span>
        <span class="k">if</span> <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;( ([A-Z]\.)*[A-Z]| Esq)\.$&quot;</span><span class="p">,</span> <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>

        <span class="c1"># field 260 includes publication information</span>
        <span class="k">if</span> <span class="s2">&quot;260&quot;</span> <span class="ow">in</span> <span class="n">marc_record</span><span class="p">:</span>
            <span class="c1"># strip trailing punctuation from publisher and pub place</span>
            <span class="c1"># subfield $a is place of publication</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;pub_place&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">marc_record</span><span class="p">[</span><span class="s2">&quot;260&quot;</span><span class="p">][</span><span class="s2">&quot;a&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;pub_place&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;pub_place&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;;:,&quot;</span><span class="p">)</span>
            <span class="c1"># if place is marked as unknown (&quot;sine loco&quot;), leave empty</span>
            <span class="k">if</span> <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;pub_place&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;[s.l.]&quot;</span><span class="p">:</span>
                <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;pub_place&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="c1"># subfield $b is name of publisher</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">marc_record</span><span class="p">[</span><span class="s2">&quot;260&quot;</span><span class="p">][</span><span class="s2">&quot;b&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;;:,&quot;</span><span class="p">)</span>
            <span class="c1"># if publisher is marked as unknown (&quot;sine nomine&quot;), leave empty</span>
            <span class="k">if</span> <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;[s.n.]&quot;</span><span class="p">:</span>
                <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># remove printed by statement before publisher name,</span>
            <span class="c1"># then strip any remaining whitespace</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">printed_by_re</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">],</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
            <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Gale/ECCO dates may include non-numeric, e.g. MDCCLXXXVIII. [1788]</span>
        <span class="c1"># try as numeric first, then extract year with regex</span>
        <span class="n">pubdate</span> <span class="o">=</span> <span class="n">marc_record</span><span class="o">.</span><span class="n">pubyear</span><span class="p">()</span>
        <span class="c1"># at least one case returns None here,</span>
        <span class="c1"># which results in a TypeError on attemped conversion to integer</span>
        <span class="k">if</span> <span class="n">pubdate</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;pub_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pubdate</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">yearmatch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pubyear_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pubdate</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">yearmatch</span><span class="p">:</span>
                    <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;pub_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">yearmatch</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()[</span><span class="s2">&quot;year&quot;</span><span class="p">])</span>

        <span class="c1"># remove brackets around inferred publishers, place of publication</span>
        <span class="c1"># *only* if they wrap the whole text</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;publisher&quot;</span><span class="p">,</span> <span class="s2">&quot;pub_place&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_data</span><span class="p">:</span>
                <span class="n">field_data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s2">&quot;^\[(.*)\]$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">field_data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">populate</span><span class="p">:</span>
            <span class="c1"># conditionally update fields that are protected (or not)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">populate_fields</span><span class="p">(</span><span class="n">field_data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">field_data</span></div>


<div class="viewcode-block" id="DigitizedWork.populate_from_bibdata">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.populate_from_bibdata">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">populate_from_bibdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bibdata</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update record fields based on Hathi bibdata information.</span>
<span class="sd">        Full record is required in order to set all fields</span>

<span class="sd">        :param bibdata: bibliographic data returned from HathiTrust</span>
<span class="sd">            as instance of :class:`ppa.archive.hathi.HathiBibliographicRecord`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># create dictionary to store bibliographic information</span>
        <span class="n">field_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># store hathi record id</span>
        <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;record_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">record_id</span>

        <span class="c1"># set fields from marc if available, since it has more details</span>
        <span class="k">if</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">marcxml</span><span class="p">:</span>
            <span class="c1"># get metadata from marcxml, but don&#39;t save it yet</span>
            <span class="n">field_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata_from_marc</span><span class="p">(</span><span class="n">bibdata</span><span class="o">.</span><span class="n">marcxml</span><span class="p">,</span> <span class="n">populate</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># fallback behavior, if marc is not availiable</span>
            <span class="c1"># use dublin core title</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">title</span>
            <span class="c1"># could guess at non-sort, but hopefully unnecessary</span>

        <span class="c1"># pub date returned in api JSON is list; use first for now (if available)</span>
        <span class="k">if</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">pub_dates</span><span class="p">:</span>
            <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;pub_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">pub_dates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">copy_details</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">copy_details</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
        <span class="c1"># hathi version/volume information for this specific copy of a work</span>
        <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;enumcron&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy_details</span><span class="p">[</span><span class="s2">&quot;enumcron&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># hathi source url can currently be inferred from htid, but is</span>
        <span class="c1"># included in the bibdata in case it changes - so let&#39;s just store it</span>
        <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;source_url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy_details</span><span class="p">[</span><span class="s2">&quot;itemURL&quot;</span><span class="p">]</span>

        <span class="c1"># should also consider storing:</span>
        <span class="c1"># - last update, rights code / rights string, item url</span>
        <span class="c1"># (maybe solr only?)</span>

        <span class="c1"># conditionally update fields that are protected (or not)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">populate_fields</span><span class="p">(</span><span class="n">field_data</span><span class="p">)</span></div>


    <span class="n">index_depends_on</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;collections&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;post_save&quot;</span><span class="p">:</span> <span class="n">SignalHandlers</span><span class="o">.</span><span class="n">collection_save</span><span class="p">,</span>
            <span class="s2">&quot;pre_delete&quot;</span><span class="p">:</span> <span class="n">SignalHandlers</span><span class="o">.</span><span class="n">collection_delete</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;cluster&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;post_save&quot;</span><span class="p">:</span> <span class="n">SignalHandlers</span><span class="o">.</span><span class="n">cluster_save</span><span class="p">,</span>
            <span class="s2">&quot;pre_delete&quot;</span><span class="p">:</span> <span class="n">SignalHandlers</span><span class="o">.</span><span class="n">cluster_delete</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">&quot;archive.DigitizedWork&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;post_save&quot;</span><span class="p">:</span> <span class="n">SignalHandlers</span><span class="o">.</span><span class="n">handle_digwork_cluster_change</span>
        <span class="p">},</span>
    <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">first_page</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of the first page in range, if this is an excerpt</span>
<span class="sd">        (first of original page range, not digital)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_page_original</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">first_page_digital</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of the first page in range (digital pages / page index),</span>
<span class="sd">        if this is an excerpt.</span>

<span class="sd">        :return: first page number for digital page range; None if no page range</span>
<span class="sd">        :rtype: int, None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages_digital</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page_span</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">first_page_original</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of the first page in range (original page numbering)</span>
<span class="sd">        if this is an excerpt</span>

<span class="sd">        :return: first page number for original page range; None if no page range</span>
<span class="sd">        :rtype: str, None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># use regex since it handles all cases (intspan only works for a subset)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([\da-z]+)([,-]|\b)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages_orig</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">last_page</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of the last page in range, if this is an excerpt</span>
<span class="sd">        (last of original page range, not digital)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_page_original</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">last_page_digital</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of the last page in range (digital pages / page index),</span>
<span class="sd">        if this is an excerpt.</span>

<span class="sd">        :return: last page number for digital page range; None if no page range</span>
<span class="sd">        :rtype: int, None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages_digital</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page_span</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">last_page_original</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of the last page in range (original page numbering) if this is an excerpt</span>

<span class="sd">        :return: last page number for original page range; None if no page range</span>
<span class="sd">        :rtype: str, None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages_orig</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages_orig</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="n">parts</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages_orig</span><span class="p">)</span>

<div class="viewcode-block" id="DigitizedWork.index_id">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.index_id">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">index_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;use source id + first page in range (if any) as solr identifier&quot;&quot;&quot;</span>
        <span class="n">first_page</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_page</span>
        <span class="k">if</span> <span class="n">first_page</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">-p</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span> <span class="n">first_page</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span></div>


<div class="viewcode-block" id="DigitizedWork.index_item_type">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.index_item_type">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">index_item_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;override index item type label to just work&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;work&quot;</span></div>


<div class="viewcode-block" id="DigitizedWork.items_to_index">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.items_to_index">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">items_to_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Queryset of works for indexing everything; excludes</span>
<span class="sd">        suppressed works.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">SUPPRESSED</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s2">&quot;collections&quot;</span><span class="p">)</span>
        <span class="p">)</span></div>

        <span class="c1"># NOTE: prefetch_related is ignored when used with Iterator,</span>
        <span class="c1"># which parasolr indexing does</span>

    <span class="c1"># specify chunk size; using previous django iterator default</span>
    <span class="n">index_chunk_size</span> <span class="o">=</span> <span class="mi">2000</span>

<div class="viewcode-block" id="DigitizedWork.prep_index_chunk">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.prep_index_chunk">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">prep_index_chunk</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
        <span class="c1"># prefetch collections when indexing in chunks</span>
        <span class="c1"># (method modifies queryset in place)</span>
        <span class="n">models</span><span class="o">.</span><span class="n">prefetch_related_objects</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="s2">&quot;collections&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">chunk</span></div>


<div class="viewcode-block" id="DigitizedWork.index_data">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.index_data">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">index_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;data for indexing in Solr&quot;&quot;&quot;</span>

        <span class="c1"># When an item has been suppressed, return id only.</span>
        <span class="c1"># This will blank out any previously indexed values, and item</span>
        <span class="c1"># will not be findable by any public searchable fields.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">SUPPRESSED</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">}</span>

        <span class="n">index_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_id</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">index_id</span><span class="p">,</span>
            <span class="s2">&quot;source_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span>
            <span class="s2">&quot;first_page_s&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_page</span><span class="p">,</span>
            <span class="s2">&quot;last_page_s&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_page</span><span class="p">,</span>
            <span class="s2">&quot;group_id_s&quot;</span><span class="p">:</span> <span class="n">index_id</span><span class="p">,</span>  <span class="c1"># for grouping pages by work or excerpt</span>
            <span class="s2">&quot;source_t&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_display</span><span class="p">(),</span>
            <span class="s2">&quot;source_url&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_url</span><span class="p">,</span>
            <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="s2">&quot;subtitle&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subtitle</span><span class="p">,</span>
            <span class="s2">&quot;sort_title&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_title</span><span class="p">,</span>
            <span class="s2">&quot;pub_date&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pub_date</span><span class="p">,</span>
            <span class="s2">&quot;pub_place&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pub_place</span><span class="p">,</span>
            <span class="s2">&quot;publisher&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">publisher</span><span class="p">,</span>
            <span class="s2">&quot;enumcron&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enumcron</span><span class="p">,</span>
            <span class="s2">&quot;author&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
            <span class="c1"># set default value to simplify queries to find uncollected items</span>
            <span class="c1"># (not set in Solr schema because needs to be works only)</span>
            <span class="s2">&quot;collections&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">collection</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="k">else</span> <span class="p">[</span><span class="n">NO_COLLECTION_LABEL</span><span class="p">],</span>
            <span class="s2">&quot;cluster_id_s&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_cluster_id</span><span class="p">,</span>
            <span class="c1"># public notes field for display on site_name</span>
            <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">public_notes</span><span class="p">,</span>
            <span class="c1"># hard-coded to distinguish from &amp; sort with pages</span>
            <span class="s2">&quot;item_type&quot;</span><span class="p">:</span> <span class="s2">&quot;work&quot;</span><span class="p">,</span>
            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;work_type_s&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">work_type</span><span class="p">,</span>
            <span class="s2">&quot;book_journal_s&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">book_journal</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="DigitizedWork.remove_from_index">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.remove_from_index">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_from_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove the current work and associated pages from Solr index&quot;&quot;&quot;</span>
        <span class="c1"># Default parasolr logic only removes current item record;</span>
        <span class="c1"># we need to remove associated pages as well</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Deleting DigitizedWork and associated pages from index with group_id </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">index_id</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solr</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">delete_by_query</span><span class="p">(</span><span class="s1">&#39;group_id_s:(&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_id</span><span class="p">())</span></div>


<div class="viewcode-block" id="DigitizedWork.count_pages">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.count_pages">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">count_pages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ptree_client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Count the number of pages for a digitized work. If a pages are specified</span>
<span class="sd">        for an excerpt or article, page count is determined based on the number of pages</span>
<span class="sd">        in the combined ranges. Otherwise, page count is based on the</span>
<span class="sd">        number of files in the zipfile within the pairtree content (Hathi-specific).</span>
<span class="sd">        Raises :class:`pairtree.storage_exceptions.ObjectNotFoundException`</span>
<span class="sd">        if the data is not found in the pairtree storage. Returns page count</span>
<span class="sd">        found; updates the `page_count` attribute on the current instance,</span>
<span class="sd">        but does NOT save the object.&quot;&quot;&quot;</span>

        <span class="c1"># if this item has a page span defined, calculate number of pages</span>
        <span class="c1"># based on the number of pages across all spans</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_span</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">page_span</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">EEBO</span><span class="p">:</span>
            <span class="c1"># update page count on the instance, but don&#39;t save changes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">page_count</span> <span class="o">=</span> <span class="n">eebo_tcp</span><span class="o">.</span><span class="n">page_count</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">page_count</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">HATHI</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">storage_exceptions</span><span class="o">.</span><span class="n">ObjectNotFoundException</span><span class="p">(</span>
                <span class="s2">&quot;Using Hathi-specific page count for non-Hathi item&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ptree_client</span><span class="p">:</span>
            <span class="n">ptree_client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hathi</span><span class="o">.</span><span class="n">pairtree_client</span><span class="p">()</span>

        <span class="c1"># count the files in the zipfile</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="c1"># could raise pairtree exception, but allow calling context to catch</span>
        <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hathi</span><span class="o">.</span><span class="n">zipfile_path</span><span class="p">(</span><span class="n">ptree_client</span><span class="p">))</span> <span class="k">as</span> <span class="n">ht_zip</span><span class="p">:</span>
            <span class="c1"># some aggregate packages retrieved from Data API</span>
            <span class="c1"># include jp2 and xml files as well as txt; only count text</span>
            <span class="n">page_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">filename</span>
                    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">ht_zip</span><span class="o">.</span><span class="n">namelist</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Counted </span><span class="si">%d</span><span class="s2"> pages in zipfile in </span><span class="si">%f</span><span class="s2"> sec&quot;</span><span class="p">,</span> <span class="n">page_count</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
            <span class="p">)</span>
        <span class="c1"># NOTE: could also count pages via mets file, but that&#39;s slower</span>
        <span class="c1"># than counting via zipfile name list</span>

        <span class="c1"># update page count on the instance, but don&#39;t save changes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_count</span> <span class="o">=</span> <span class="n">page_count</span>
        <span class="c1"># return the total</span>
        <span class="k">return</span> <span class="n">page_count</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">page_span</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: relabel to make it explicit that this is digital pages?</span>
        <span class="c1"># convert the specified page numbers into an intspan</span>
        <span class="c1"># if empty, returns an empty set</span>
        <span class="k">return</span> <span class="n">intspan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages_digital</span><span class="p">)</span>

<div class="viewcode-block" id="DigitizedWork.get_source_link_label">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.get_source_link_label">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_source_link_label</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Source-specific label for link on public item detail view.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">GALE</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;View on Gale Primary Sources&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">OTHER</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;View external record&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;View on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_source_display</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="DigitizedWork.add_from_hathi">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.DigitizedWork.add_from_hathi">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_from_hathi</span><span class="p">(</span><span class="n">htid</span><span class="p">,</span> <span class="n">bib_api</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">log_msg_src</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add or update a HathiTrust work in the database.</span>
<span class="sd">        Retrieves bibliographic data from Hathi api, retrieves or creates</span>
<span class="sd">        a :class:`DigitizedWork` record, and populates the metadata if</span>
<span class="sd">        this is a new record, if the Hathi metadata has changed, or</span>
<span class="sd">        if update is requested. Creates admin log entry to document</span>
<span class="sd">        record creation or update.</span>

<span class="sd">        Raises :class:`ppa.archive.hathi.HathiItemNotFound` for invalid</span>
<span class="sd">        id.</span>

<span class="sd">        Returns the new or updated  :class:`~ppa.archive.models.DigitizedWork`.</span>

<span class="sd">        :param htid: HathiTrust record identifier</span>
<span class="sd">        :param bib_api: optional :class:`~ppa.archive.hathi.HathiBibliographicAPI`</span>
<span class="sd">            instance, to allow for shared sessions in scripts</span>
<span class="sd">        :param update: update bibliographic metadata even if the hathitrust</span>
<span class="sd">            record is not newer than the local database record (default: False)</span>
<span class="sd">        :param log_msg_src: source of the change to be used included</span>
<span class="sd">            in log entry messages (optional). Will be used as &quot;Created/updated</span>
<span class="sd">            [log_msg_src]&quot;.</span>
<span class="sd">        :param user: optional user responsible for the change,</span>
<span class="sd">            to be associated with :class:`~django.admin.models.LogEntry`</span>
<span class="sd">            record</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># initialize new bibliographic API if none is passed in</span>
        <span class="n">bib_api</span> <span class="o">=</span> <span class="n">bib_api</span> <span class="ow">or</span> <span class="n">HathiBibliographicAPI</span><span class="p">()</span>

        <span class="c1"># set a default log message source if not specified</span>
        <span class="n">log_msg_src</span> <span class="o">=</span> <span class="n">log_msg_src</span> <span class="ow">or</span> <span class="s2">&quot;from HathiTrust bibliographic data&quot;</span>

        <span class="c1"># get bibliographic data for this record from Hathi api</span>
        <span class="c1"># - needed to check if update is required for existing records,</span>
        <span class="c1">#   and to populate metadata for new records</span>

        <span class="c1"># could raise HathiItemNotFound for invalid id</span>
        <span class="n">bibdata</span> <span class="o">=</span> <span class="n">bib_api</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="s2">&quot;htid&quot;</span><span class="p">,</span> <span class="n">htid</span><span class="p">)</span>

        <span class="c1"># if hathi id is valid and we have bibliographic data, create</span>
        <span class="c1"># a new record</span>

        <span class="c1"># find existing record or create a new one</span>
        <span class="c1"># @NOTE @BUG: This is sometimes returning &gt;1 entry and failing. Need to find why</span>
        <span class="n">digwork</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">source_id</span><span class="o">=</span><span class="n">htid</span><span class="p">)</span>

        <span class="c1"># get configured script user for log entries if no user passed in</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SCRIPT_USERNAME</span><span class="p">)</span>

        <span class="c1"># if this is an existing record, check if updates are needed</span>
        <span class="n">source_updated</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">created</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">source_updated</span> <span class="o">=</span> <span class="n">bibdata</span><span class="o">.</span><span class="n">copy_last_updated</span><span class="p">(</span><span class="n">htid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">digwork</span><span class="o">.</span><span class="n">updated</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">source_updated</span><span class="p">:</span>
                <span class="c1"># local copy is newer than last source modification date</span>
                <span class="c1"># and update is not requested; return un modified</span>
                <span class="k">return</span> <span class="n">digwork</span>

        <span class="c1"># populate digitized item in the database</span>
        <span class="n">digwork</span><span class="o">.</span><span class="n">populate_from_bibdata</span><span class="p">(</span><span class="n">bibdata</span><span class="p">)</span>
        <span class="n">digwork</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="c1"># create a log entry to document record creation or change</span>
        <span class="c1"># if created, action is addition and message is creation</span>
        <span class="n">log_change_message</span> <span class="o">=</span> <span class="s2">&quot;Created </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">log_msg_src</span>
        <span class="n">log_action</span> <span class="o">=</span> <span class="n">ADDITION</span>
        <span class="c1"># if this was not a new record, log as an update</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">created</span><span class="p">:</span>
            <span class="c1"># create log entry for updating an existing record</span>
            <span class="c1"># include details about why the update happened if possible</span>
            <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
                <span class="n">msg_detail</span> <span class="o">=</span> <span class="s2">&quot; (forced update)&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg_detail</span> <span class="o">=</span> <span class="s2">&quot;; source record last updated </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">source_updated</span>
            <span class="n">log_change_message</span> <span class="o">=</span> <span class="s2">&quot;Updated </span><span class="si">%s%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">log_msg_src</span><span class="p">,</span> <span class="n">msg_detail</span><span class="p">)</span>
            <span class="n">log_action</span> <span class="o">=</span> <span class="n">CHANGE</span>

        <span class="c1"># create log entry for record creation</span>
        <span class="n">LogEntry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">log_action</span><span class="p">(</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">content_type_id</span><span class="o">=</span><span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">digwork</span><span class="p">)</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="n">object_id</span><span class="o">=</span><span class="n">digwork</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span>
            <span class="n">object_repr</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">digwork</span><span class="p">),</span>
            <span class="n">change_message</span><span class="o">=</span><span class="n">log_change_message</span><span class="p">,</span>
            <span class="n">action_flag</span><span class="o">=</span><span class="n">log_action</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">digwork</span></div>
</div>



<div class="viewcode-block" id="Page">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.Page">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Page</span><span class="p">(</span><span class="n">Indexable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Indexable for pages to make page data available for indexing with</span>
<span class="sd">    parasolr index manage command.&quot;&quot;&quot;</span>

    <span class="n">index_chunk_size</span> <span class="o">=</span> <span class="mi">2000</span>

<div class="viewcode-block" id="Page.items_to_index">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.Page.items_to_index">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">items_to_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a generator of page data to be indexed, with data for</span>
<span class="sd">        pages for each work returned by :meth:`Page.page_index_data`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">items_to_index</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">page_data</span> <span class="ow">in</span> <span class="n">Page</span><span class="o">.</span><span class="n">page_index_data</span><span class="p">(</span><span class="n">work</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">page_data</span></div>


<div class="viewcode-block" id="Page.total_to_index">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.Page.total_to_index">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_to_index</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the total number of pages to be indexed by</span>
<span class="sd">        aggregating page count of items to index in the database.&quot;&quot;&quot;</span>
        <span class="n">digworks</span> <span class="o">=</span> <span class="n">DigitizedWork</span><span class="o">.</span><span class="n">items_to_index</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">digworks</span> <span class="o">=</span> <span class="n">digworks</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">digworks</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">total_pages</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Sum</span><span class="p">(</span><span class="s2">&quot;page_count&quot;</span><span class="p">))[</span><span class="s2">&quot;total_pages&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Page.index_item_type">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.Page.index_item_type">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">index_item_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;index item type for parasolr indexing script&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;page&quot;</span></div>


<div class="viewcode-block" id="Page.page_index_data">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.Page.page_index_data">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">page_index_data</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">digwork</span><span class="p">,</span> <span class="n">gale_record</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get page content for the specified digitized work from Hathi</span>
<span class="sd">        pairtree and return data to be indexed in solr.</span>

<span class="sd">        Takes an optional Gale item record as returned by the Gale API,</span>
<span class="sd">        to avoid loading API content twice. (Used on import)&quot;&quot;&quot;</span>

        <span class="c1"># suppressed items are not indexed; bail out</span>
        <span class="k">if</span> <span class="n">digwork</span><span class="o">.</span><span class="n">is_suppressed</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># get a generator of page data from the appropriate source</span>
        <span class="k">if</span> <span class="n">digwork</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">digwork</span><span class="o">.</span><span class="n">HATHI</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">digwork</span><span class="o">.</span><span class="n">hathi</span><span class="o">.</span><span class="n">page_data</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">digwork</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">digwork</span><span class="o">.</span><span class="n">GALE</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">GaleAPI</span><span class="p">()</span><span class="o">.</span><span class="n">get_item_pages</span><span class="p">(</span><span class="n">digwork</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span> <span class="n">gale_record</span><span class="o">=</span><span class="n">gale_record</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">digwork</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="n">digwork</span><span class="o">.</span><span class="n">EEBO</span><span class="p">:</span>
            <span class="n">pages</span> <span class="o">=</span> <span class="n">eebo_tcp</span><span class="o">.</span><span class="n">page_data</span><span class="p">(</span><span class="n">digwork</span><span class="o">.</span><span class="n">source_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># no other sources currently support full-text indexing</span>
            <span class="k">return</span>

        <span class="c1"># get page span from digitized work, to handle excerpts</span>
        <span class="n">page_span</span> <span class="o">=</span> <span class="n">digwork</span><span class="o">.</span><span class="n">page_span</span>
        <span class="c1"># if indexing an excerpt, determine highest page to be indexed</span>
        <span class="n">max_page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">page_span</span><span class="p">)</span> <span class="k">if</span> <span class="n">page_span</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="c1"># index id is used to group work and pages; also fallback for cluster id</span>
        <span class="c1"># for works that are not part of a cluster</span>
        <span class="n">digwork_index_id</span> <span class="o">=</span> <span class="n">digwork</span><span class="o">.</span><span class="n">index_id</span><span class="p">()</span>

        <span class="c1"># enumerate with 1-based index for digital page number</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">page_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pages</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1"># page info is expected to contain page_id, content, order, label</span>
            <span class="c1"># may contain tags, image id, image url</span>

            <span class="c1"># if indexing a page range, stop iterating once we are</span>
            <span class="c1"># past the highest page in range and close the generator</span>
            <span class="k">if</span> <span class="n">max_page</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">max_page</span><span class="p">:</span>
                <span class="n">pages</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="c1"># NOTE: on OSX, when used with multiproc index_pages, requires</span>
                <span class="c1"># environment variable OBJC_DISABLE_INITIALIZE_FORK_SAFETY=&quot;YES&quot;</span>

            <span class="c1"># if the document has a page range defined, skip any pages not in range</span>
            <span class="k">if</span> <span class="n">page_span</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">page_span</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># remove page id and use in combination with digwork index id</span>
            <span class="c1"># to generate unique id.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">page_id</span> <span class="o">=</span> <span class="n">page_info</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;page_id&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c1"># if page id is not set, use enumeration id</span>
                <span class="n">page_id</span> <span class="o">=</span> <span class="n">i</span>

            <span class="c1"># update with common fields needed for all pages across sources</span>
            <span class="n">page_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">digwork_index_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">page_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;source_id&quot;</span><span class="p">:</span> <span class="n">digwork</span><span class="o">.</span><span class="n">source_id</span><span class="p">,</span>
                    <span class="s2">&quot;group_id_s&quot;</span><span class="p">:</span> <span class="n">digwork_index_id</span><span class="p">,</span>  <span class="c1"># for grouping with work record</span>
                    <span class="s2">&quot;cluster_id_s&quot;</span><span class="p">:</span> <span class="n">digwork</span><span class="o">.</span><span class="n">index_cluster_id</span><span class="p">,</span>  <span class="c1"># for grouping with cluster</span>
                    <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                    <span class="c1"># make sure label is set;</span>
                    <span class="c1"># fallback to sequence number if no (or null) label, but mark with brackets</span>
                    <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">page_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;item_type&quot;</span><span class="p">:</span> <span class="s2">&quot;page&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="k">yield</span> <span class="n">page_info</span></div>
</div>



<div class="viewcode-block" id="SourceNote">
<a class="viewcode-back" href="../../../codedocs.html#ppa.archive.admin.SourceNote">[docs]</a>
<span class="nd">@register_snippet</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SourceNote</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">DigitizedWork</span><span class="o">.</span><span class="n">SOURCE_CHOICES</span><span class="p">,</span>
        <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># only allow one note per source</span>
    <span class="p">)</span>
    <span class="n">note</span> <span class="o">=</span> <span class="n">RichTextField</span><span class="p">(</span>
        <span class="n">features</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="s2">&quot;italic&quot;</span><span class="p">,</span> <span class="s2">&quot;link&quot;</span><span class="p">],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;A brief note to appear next to the source name in search results, as a tooltip&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_source_display</span><span class="p">()</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../index.html">
    <img class="logo" src="../../../_static/ppa_logo.png" alt="Logo" />
    
    <h1 class="logo logo-name">Princeton Prosody Archive</h1>
    
  </a>
</p>



<p class="blurb">Django web application for "Princeton Prosody Archive" CDH project</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Princeton-CDH&repo=ppa-django&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../codedocs.html">Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deploynotes.html">Deploy Notes</a></li>
</ul>


<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><div class="powered_by">
<p>Powered by:</p>
<a href="http://cdh.princeton.edu/">
<img src="https://cdh.princeton.edu/static/img/CDH_logo.svg"
    alt="Center for Digital Humanities @ Princeton" />
</a>
</div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, CDH @ Princeton University.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>